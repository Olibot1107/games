name: Generate README with Changelog

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate changelog table
        run: |
          echo "# ðŸ“œ Project Changelog" > README.md
          echo "" >> README.md
          echo "| Commit | Message | Author | Date | Files Changed |" >> README.md
          echo "|--------|---------|--------|------|---------------|" >> README.md

          # Loop through commits and collect info
          git log --pretty=format:"%H|%h|%s|%an|%ad" --date=short | while IFS="|" read full short msg author date
          do
            files=$(git show --pretty="" --name-only $full | wc -l)
            echo "| [$short](https://github.com/${{ github.repository }}/commit/$full) | $msg | $author | $date | $files |" >> README.md
          done

      - name: Commit & Push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "chore: update README with changelog" || echo "No changes to commit"
          git push
