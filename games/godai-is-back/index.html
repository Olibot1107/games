<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Godai's back</title>
    
    <style>
        html {
            background: #000;
            text-align: center;
        }
        canvas {
            background: #000;
            margin-top: 130px;
            image-rendering: -moz-crisp-edges;         /* Firefox */
            image-rendering: -webkit-crisp-edges;      /* Webkit */
            -ms-interpolation-mode: nearest-neighbor;  /* IE (non-standard property) */
            image-rendering: pixelated;                /* Chrome */
            border: 1px solid white;
            transform: scale(3)
        }
        img, #hide {
            display: none;
        }
    </style>
</head>
<body>
    <canvas width=160 height=144></canvas>
    
    <p id="hide">
    // bg std (b1) - 160x144
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAACQCAMAAAC4a5CyAAAAOVBMVEVxc17Fw7YyNCny8uxyc2EyMiszNSjFw7Pz8u1wcF8zNCzw7+vIxrcxMyXHxbY0NivFxrTGx7k2NioE1GbyAAAFO0lEQVR42u2cjZaaMBCFExmcTBG0ff+HLROCg4Qg+bGmLZeDy8jp8HG5ISv2rLpUrhPwBIzUCVid6gcsqcZJldS1kNrGmBnQGNOW6lvqEnfNWj/KNC4EaDzAzpTprEoImk2BqkWd2eIzZQbLJVuSv0/kMAvQz1/5HKp8NTsCUl+WDJBqB0q3x2fg6zNJb3YB+9z+H0tgqXn5BFSR+vsA9bZIhYT6Re9m47d9Ue8qBDgE+TYBiQJ86l1fTATURx1XTqF55F1f/UbRlxhu5S6x9AvLy0J0Js3uBIdp2RMdzcIQAwgeRmz2RMezEBDs/w6DadkTeVmIuMTh8QviU1L29gdJLGhjmoBMp44LywAOMb8RdhDBlw8YzmJjsv1TBS+xL8j2L5xJFQ8U8PCofxg356uYzIUFh/1DjJvzI+5/UYgQN5f7KnSJRUTLx2+wk7W4OV8dhPGzkys8aIafh5zsJN/3wj29PERkJ0eH8+5ZnJGdzPseHTkTKpu7/HyuAYf83OULfUBRfu7ytTfVUdnc5edTnTr1Twg3x2IFj39nIfoj/FERYAAFVSUSr3xfS4gAru24Xka1kDxzwsZkkNDNcVim+a2+v9/HlXfc+zRAuMErDGlKA3QcExN439aleRj6PSjVP5EHyOyJc+eAL2LkFP98QMcsKvagGwp89wobgNdryjgbeVg3PW7PVfy3XluAPf+49uM+GOH6Cysphy57JFWkpvE7rrzV2tfrSAIWEDRZQEgBnDLnsjdIlQIIPQPCT+i5BuLrDuPCgHoE1Ck51AGl5E/bVaG62kUJ4GD3UQqgy57I1SmA8IsB8QWQg2hduPacxqSRjBr8Oh6Qk9demAUYTgDJ3reuwGlMAZRhIXUKICcPer6vIkyAkiJQvC/jg5j/RpJ61fv//KE1JwaIcCX6NCCupECBncs10rIbxX/vmQ+4d8zXmYgAEWU3LKQHpE8BIq6ONWtA5HrrPGAZcKkO8cUSousPL5WI5DzEOQ8QCW5InwBkl5DWgOKku3Zbd30BdKv+ACBqByeAW+F0WwCI6jEuW4AP9rA0ICLgNiCSeiC8PKOeoTS8ArpzlD07fD7gPqHrSxsOarf9BKQZClaAgJwTRbKnnLivO8IakNw2TYBj6aBQs+bMuW2lPymxeoLSVg4QLQkgbgByClj2HvmqMvY5zQXiFiAi3JYZ1AJo8/HnRIqP7gFaGrjBzQGS5gVsdAlR/zkNCModmZcZ0H7a1vCcL3hx0n9eMoZnBye2xexB4/JAkpCICmcw2BiRKWbAl8MtRhTqL8kenrxZRQAR7ZzyNUA7fwxIIUBkfv1NueOHAQlQf1cDQAiQ7I4KpNhHHxAQAKsARGAW71my/v7/GRdNNDjzWQEeVBGTdiU0ND8L/f7ofZHwPD+RfH30rjXAzVpNqkr/lh5W6d/CQ/UV//C4h6pS/54eqirzt/BQVeuf81DpukW1Aw61A2oFlat+B3XlOgFPwEidgNWp/j8EcalcI2DTNdnyGxfqy4CmzZbx8Ur1ZQfbS642HCzT9wQ8AU/A44BNY1/aZtIP+yp1Wwrw2V+OJ3U31u79HcCW9cP+NK425QClv2m5WNZmF5DlOShn+gEHu8kxqZ+OdhuXWBwTB8e1OKD0vzvHpJ52spehDHbi3LreB/Qz/N7B8PE2B0k7vt7HM2kn/VjVEYAtKwjo9/fr8reZ+ew7yXJ198F72xnTOodMhYDs4TJjFQLe20XGagT83+fiE/AEPAH/YsAf2Y06/61SfdX4arK1AVim79/x8Khu/QYODYcXfP9JtwAAAABJRU5ErkJggg==" id="b1">
    
    // bg death (b2) - 160x144
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAACQAQMAAAC1e/LDAAAABlBMVEXEw7UyMyk6MQVsAAAANUlEQVRIx2P4jwWMCo4KkiOIDVBqJtGAQjMptWgUjIJRMApGwfAG9KpQKLRoMFblo4K0FwQAsvarjXDOGDcAAAAASUVORK5CYII=" id="b2">
    
    // godai (g) - 55x55
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAwIAAAA3BAMAAABNzeAIAAAAFVBMVEUAAAAyMyny8e5yc1/Ew7Xx8Ovy8uneVHlPAAAAAXRSTlMAQObYZgAABqhJREFUeNrsmGGO2yAQhR+0B5gHewBmqu1/NheoVj1AmyPs/Q/RjZIqqcO4tWWUas33kxHG4vMbLLBDIjFYwBDw4VAMHkoUDBYxIvDBGBF4LH4EjvYVA4/+EXgzkiMdFwoc+kQgAPGZ4w/1SjT0I0rDQNSx/7eYdQtBEG0MJh3t5xZNZugF5f4E0NH/bwnRvhz6hUDlzslxJGDSEszsxdCHaJwKYCrDwB+wmL32CgHtbiQVBBIegfyGXREpsO+dDJiW+wULSPGd8Qn7QiGIXTJg75SmAZsxYHszEAUITB0MRHsn3j/3reBZZwzo0766kJ6Tb4KtMSNgjfGC+JPweNV9nQNRzga4uYFgaiE5Bvz1rrVt+yH+VxQXA9gaGtMnltZ2/GCliDevMnPrMLpWH345eI5A6JCBQCVZmwbITKG3JflUxTYEIBoJl+AUF9pZP0fx2wA3N3CiilOqlYBfI1ax/A4w0NbYIWW5UT8CIFm3N5BJ1vbr81TETC1NsxOxnL/fAYbKZGvsBBK05rgtjEBnA4IGvGbAqd1fFRrWEHW+KWQeXsoKO5m0pgHWZIvalFx7L9f2GrdSXQOJma4BzawyvS+PVrCCZLMCQs6VZd6OL0dT44FMZcmORbmMHtzOu/7kObiHC4+5skq7lrSyIhonBkAKBItgMjlPcw1M3jH8k51zm/xMTGEmdd45aa31SMq6j9137h/v6Vc7Z5fjNQwD8biI90zKAZJB4pmqV+AEHIH7HwJBd3FbdxLCh3ghAq023kkc/2In23+1n6UpGRvwMaXl6hA/YQcwS4B7V2brPU9Ln46nxw6SD3m/7lvPSWwojwRstLi8qorCVm4lY4h1IXTKsWE9Pjaq+dy7YprAWIbtuhdQf4rOdzgPy17atmHN3RQQW1YScLhgFRudpBp0/i2JhQ14id6ZADaAswTGshU4nRVgl87dROBOwDNOEVj3s8in9rnUr0lFE6gUIjEoW4/Aq2pBCFWbIzCWGXb41gLHdDwHsITlsa59AsuK7fwDVk9xHBNoggCWmpQpSwJIAzqGms6L3rfSZgEMZQBQmCzc/rt0gA1srOXuPAc5QFzuJ1Z8RBcqAiDErf+dOgZEnBd25uMPlaVyDuXE0yIhk06yWkooHNPxVW9kJLDwqPOycV0Bth8Aaj9YN+hPR4y92Tc0UZ8kgaYJkCeV1evd9uM8gX2Y3EBd2ADWLp2wtkImC0dxOC9v9g0bSg0ADIMkgHrGYwaIJNcEPkMT5yU/yrkotzkCLhs9vGJjK+zTibK0HASCgUy6NaxbYcp+j+8TcHsDdmRx0s0ReMsegUt++AoNZf4lo7EMLwRq7tKRt7zyoCkc5Fz+Np2BNQQLGkBpwm6SnBxzkQTiZijez4ZpAFrmsx2FO2s67/NzHAMBL1yDCRcenCKBLEUUBFB+g0DWBHC/raGwYQ6BlmkfNZ0oy4pAqYMJC++U8NqEHweB9uAJq84N91PZpIsxCVDovVME4jxx503ScZnVJwvbYEKaWDaylDSUluOZIy79OLXfI2DVQ+ndkzmAQUDQtWmTJtCvC4DJeCkJEQoqSb/HThEIpl7qlFcNu9cFQHSTQSZ2nrRpJzUBdIlD9QNKQhQCWboiCYi8UouLntirobBXtMNgQqZnk0HpyAQB9ShKBcXGOVDYSnNdFOa/R6C+Gkh2d3OOiRBl81FG7jlZwpASgY4XxtEqjAeh4dz+GoGUX0WF7elG9mbfZDJGmY6IXkFHJgj4WfCnCGCSgIUxp7deDgTA9jTgpvzQsvHCbYKAGDLeAaAJjMuh3+qmCeBXCUQRH1RvXDKSTe/zcYntEEBeyCrGnCWQzWXTTqKz8EFdGDM1GjC9FcY2TBPQMRkTsCGBY1Lip7fQmRtmkn82lCBxbflvE7AugeGYJqDmHoGcwvk+iORx9P1xAlGF0vY9nARaFtfW2ed5OCRynqzM2QScbz+hCPhnaNfz/YT0ripHX3BkFBQMCZQGXATrt39CJ2U+WzZd9PzJRJSNa2UJs2kCCe31rfJ7c8eZXz5G9x45oJV0+NYhkNz/6KVSHXfLi2DDt//eqpSJdwIMAHmLF3l4d0hrkOUEIXtltkTZseInXXrpiIal0Aeox1fW8wLs4mP49M18Nh+yvXD58uHOm8Th5sL6vLaFF245bQDZAA91VbIANcv3aoALxBkZIGVC5/M9ZpXww4cMNjWbf//S9VRpXma06OK3PoMhhV8HCsnGoygWIj/J/v8Nhb/W3gAgyXacPf9D/a/aMvUu0VfYCik7WbQhnwAAAABJRU5ErkJggg==" id="g">
    
    // slash (e) - 40x49
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAAxAgMAAABsXYXlAAAACVBMVEUAAADy8e7y9OIQWR5nAAAAAXRSTlMAQObYZgAAAORJREFUOMut1F0OwyAIB3BZ5vsexn04Ag9wnx19H6nlL1rTZG3SpOEXBS1a5g9pWT1sS3ZfKbnLgqv7kBwC7G7DEIHUI5NB6kltezl1yqyRelJ69Ug9ZYHJNTPtoQM2qE2Pd5oOWPK+PIB5Z26sHWtL3lg6tnNM3eQxJrNNuVzD3nEs/CTLmvUqZuAtzvYX65IrsCNLnKyR2xd93ns0YOItQbWNh6aNeA0mt541sfZspTCyYP//wB06NXAbR8iWWSowa2bFY8mC/BVjYC+Z8cYgG5mD40fARRbLfgZBl7XCb68WfwOGMmf4RUK0uQAAAABJRU5ErkJggg==" id="e">
    
    // weapon / sword flying (w) - 25x25
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAZBAMAAAA1cJZ4AAAAFVBMVEUAAAAyMyny8e4zNCsxMify8evz8fL5yvVMAAAAAXRSTlMAQObYZgAAAJ1JREFUOMvN0NENwjAMBNBLJP5zwADEE1CxAIgJkFiA/ZdAldK6TZXY/Wu+IllPvjMAhIQ97wikPeFhCdejMP8GUyghuwSxJmQhFyeRXADwfiUHiaJBBzb759UKIM3eQYQJS3I3iZQSSqz+kfXkY5GMHaRV9ot+mbAdnJ6OK3f6s0pmE4qL4DclDhRXMiU8q/AkC6Tc3Ae4PkayXPEHYz0LAk651wwAAAAASUVORK5CYII=" id="w">
    
    // life meter (l) - 40x5
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAFAQMAAAANAjzGAAAABlBMVEXy8e3Fw7b5zSdKAAAADUlEQVQI12PABf6DAAAPDwT8G4kgbAAAAABJRU5ErkJggg==" id="l">
    
    // waiting for opponent (i) - 95x7
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAF8AAAAHAQMAAABUXwMsAAAABlBMVEUAAADy8e3AO1BIAAAAAXRSTlMAQObYZgAAAFpJREFUCNdjmOj6ibnPmHHGYYUncgyzUoJcOLyaQpYsaWlhiFoS7MHR1mKyoqSthSFrSdDJvnYWmxc5T4GcL0FHOryaAlrWtLYwqIoEuXdUOV9oX/KkhQEZAACALiEiM8yL/gAAAABJRU5ErkJggg==" id="i">
    
    // click to start (q) - 59x6
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAAGAQMAAABHD3SDAAAABlBMVEUAAADy8e3AO1BIAAAAAXRSTlMAQObYZgAAADdJREFUCNdjsGif+Izvk+EDBo+OBZ4CyhoODB0TDgR0qEIZbaoGDmApJvUVDgx1/Rv85TSWOAAAHdUTHMpz+68AAAAASUVORK5CYII=" id="q">
    </p>
    
    <script src="socket.io/socket.io.js"></script>
    <script>
      /*
       * Kontra.js v4.0.1 (Custom Build on 2018-09-11) | MIT
       * Build: https://straker.github.io/kontra/download?files=gameLoop+keyboard+sprite+assets+spriteSheet
       */
      kontra={init(t){var n=this.canvas=document.getElementById(t)||t||document.querySelector("canvas");this.context=n.getContext("2d")},_noop:new Function,_tick:new Function};
      kontra.gameLoop=function(e){let t,n,a,r,o=(e=e||{}).fps||60,i=0,p=1e3/o,c=1/o,s=!1===e.clearCanvas?kontra._noop:function(){kontra.context.clearRect(0,0,kontra.canvas.width,kontra.canvas.height)};function d(){if(n=requestAnimationFrame(d),a=performance.now(),r=a-t,t=a,!(r>1e3)){for(kontra._tick(),i+=r;i>=p;)m.update(c),i-=p;s(),m.render()}}let m={update:e.update,render:e.render,isStopped:!0,start(){t=performance.now(),this.isStopped=!1,requestAnimationFrame(d)},stop(){this.isStopped=!0,cancelAnimationFrame(n)}};return m};
      !function(){let n={},t={},e={13:"enter",27:"esc",32:"space",37:"left",38:"up",39:"right",40:"down"};for(let n=0;n<26;n++)e[65+n]=(10+n).toString(36);for(i=0;i<10;i++)e[48+i]=""+i;addEventListener("keydown",function(i){let c=e[i.which];t[c]=!0,n[c]&&n[c](i)}),addEventListener("keyup",function(n){t[e[n.which]]=!1}),addEventListener("blur",function(n){t={}}),kontra.keys={bind(t,e){[].concat(t).map(function(t){n[t]=e})},unbind(t,e){[].concat(t).map(function(t){n[t]=e})},pressed:n=>!!t[n]}}();
      !function(){class t{constructor(t,i){this._x=t||0,this._y=i||0}add(t,i){this.x+=(t.x||0)*(i||1),this.y+=(t.y||0)*(i||1)}clamp(t,i,h,s){this._c=!0,this._a=t,this._b=i,this._d=h,this._e=s}get x(){return this._x}get y(){return this._y}set x(t){this._x=this._c?Math.min(Math.max(this._a,t),this._d):t}set y(t){this._y=this._c?Math.min(Math.max(this._b,t),this._e):t}}kontra.vector=((i,h)=>new t(i,h)),kontra.vector.prototype=t.prototype;class i{init(t,i,h,s){for(i in t=t||{},this.position=kontra.vector(t.x,t.y),this.velocity=kontra.vector(t.dx,t.dy),this.acceleration=kontra.vector(t.ddx,t.ddy),this.width=this.height=0,this.context=kontra.context,t)this[i]=t[i];if(h=t.image)this.image=h,this.width=h.width,this.height=h.height;else if(h=t.animations){for(i in h)this.animations[i]=h[i].clone(),s=s||h[i];this._ca=s,this.width=s.width,this.height=s.height}return this}get x(){return this.position.x}get y(){return this.position.y}get dx(){return this.velocity.x}get dy(){return this.velocity.y}get ddx(){return this.acceleration.x}get ddy(){return this.acceleration.y}set x(t){this.position.x=t}set y(t){this.position.y=t}set dx(t){this.velocity.x=t}set dy(t){this.velocity.y=t}set ddx(t){this.acceleration.x=t}set ddy(t){this.acceleration.y=t}isAlive(){return this.ttl>0}collidesWith(t){return this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y}update(t){this.advance(t)}render(){this.draw()}playAnimation(t){this._ca=this.animations[t],this._ca.loop||this._ca.reset()}advance(t){this.velocity.add(this.acceleration,t),this.position.add(this.velocity,t),this.ttl--,this._ca&&this._ca.update(t)}draw(){this.image?this.context.drawImage(this.image,this.x,this.y):this._ca?this._ca.render(this):(this.context.fillStyle=this.color,this.context.fillRect(this.x,this.y,this.width,this.height))}}kontra.sprite=(t=>(new i).init(t)),kontra.sprite.prototype=i.prototype}();
      !function(){let n,e=/(jpeg|jpg|gif|png)$/,t=/(wav|mp3|ogg|aac)$/,a=/^no$/,o=/^\//,i=/\/$/,r=new Audio,c={wav:"",mp3:r.canPlayType("audio/mpeg;").replace(a,""),ogg:r.canPlayType('audio/ogg; codecs="vorbis"').replace(a,""),aac:r.canPlayType("audio/aac;").replace(a,"")};function u(n,e){return[n.replace(i,""),n?e.replace(o,""):e].filter(n=>n).join("/")}function l(n){return n.split(".").pop()}function f(n){let e=n.replace("."+l(n),"");return 2==e.split("/").length?e.replace(o,""):e}function s(e,t){return new Promise(function(a,o){let i=new Image;t=u(n.imagePath,e),i.onload=function(){n.images[f(e)]=n.images[t]=this,a(this)},i.onerror=function(){o(t)},i.src=t})}function d(e,t,a){return new Promise(function(o,i){if(e=[].concat(e).reduce(function(n,e){return c[l(e)]?e:n},a)){let a=new Audio;t=u(n.audioPath,e),a.addEventListener("canplay",function(){n.audio[f(e)]=n.audio[t]=this,o(this)}),a.onerror=function(){i(t)},a.src=t,a.load()}else i(e)})}function p(e,t){return t=u(n.dataPath,e),fetch(t).then(function(n){if(!n.ok)throw n;return n.clone().json().catch(function(){return n.text()})}).then(function(a){return n.data[f(e)]=n.data[t]=a,a})}n=kontra.assets={images:{},audio:{},data:{},imagePath:"",audioPath:"",dataPath:"",load(){let n,a,o,i,r,c=[];for(i=0;o=arguments[i];i++)r=(a=l(n=[].concat(o)[0])).match(e)?s(o):a.match(t)?d(o):p(o),c.push(r);return Promise.all(c)}}}();
      !function(){class t{constructor(t,i){t=t||{},this.spriteSheet=t.spriteSheet,this.frames=t.frames,this.frameRate=t.frameRate,this.loop=void 0===t.loop||t.loop,i=t.spriteSheet.frame,this.width=i.width,this.height=i.height,this.margin=i.margin||0,this._f=0,this._a=0}clone(){return kontra.animation(this)}reset(){this._f=0,this._a=0}update(t){if(this.loop||this._f!=this.frames.length-1)for(t=t||1/60,this._a+=t;this._a*this.frameRate>=1;)this._f=++this._f%this.frames.length,this._a-=1/this.frameRate}render(t){t=t||{};let i=this.frames[this._f]/this.spriteSheet._f|0,e=this.frames[this._f]%this.spriteSheet._f|0;(t.context||kontra.context).drawImage(this.spriteSheet.image,e*this.width+(2*e+1)*this.margin,i*this.height+(2*i+1)*this.margin,this.width,this.height,t.x,t.y,this.width,this.height)}}kontra.animation=function(i){return new t(i)},kontra.animation.prototype=t.prototype;class i{constructor(t){t=t||{},this.animations={},this.image=t.image,this.frame={width:t.frameWidth,height:t.frameHeight,margin:t.frameMargin},this._f=t.image.width/t.frameWidth|0,this.createAnimations(t.animations)}createAnimations(t){let i,e,h,s;for(s in t)e=(i=t[s]).frames,h=[],[].concat(e).map(function(t){h=h.concat(this._p(t))},this),this.animations[s]=kontra.animation({spriteSheet:this,frames:h,frameRate:i.frameRate,loop:i.loop})}_p(t,i){if(+t===t)return t;let e=[],h=t.split(".."),s=i=+h[0],a=+h[1];if(s<a)for(;i<=a;i++)e.push(i);else for(;i>=a;i--)e.push(i);return e}}kontra.spriteSheet=function(t){return new i(t)},kontra.spriteSheet.prototype=i.prototype}();

      class Game {
        constructor(){
          this.init();
        }

        init() {
          kontra.init();

          let imgs = ["b1", "b2", "g", "e", "w", "l", "i", "q"];
          imgs.forEach(im => {
            kontra.assets.images[im] = document.getElementById(im);
          });

          this.main();
        }

        main() {
          let STATE_INTRO = 0, STATE_PLAY = 1, STATE_CLICK = 2;
          let STOP_FRAME = 23, INVISIBLE_FRAME = 24, DEATH_END_FRAME = 25;
          let DOUBLE_PRESS_LIMIT = .8, FAST_ADVANCE_PX = 8, LOW_HIT = 20, HIGH_HIT = 15;
          let M = Math, RND = M.random, CW = 160, CH = 144, ctx = kontra.context;
          let gameState = STATE_CLICK, socket;
          let DEBUG_GUARD_ACTIVE = true;

          let bindSocket = function() {
            socket.on("match", () => {
              if (gameState != STATE_INTRO) return;
              gameState = STATE_PLAY;
            });

            socket.on("mov", (ev, pos) => {
              if (gameState != STATE_PLAY) return;
              enemy.x = pos;
              enemy.goesTo = ev;
            });

            socket.on("dmg", (q) => {
              if (gameState != STATE_PLAY) return;
              heroLife.percent -= q;
              playSound(hitSnd);
            });

            socket.on("end", () => {
              gameState = STATE_INTRO;
            });

            socket.on("disconnect", () => {
              gameState = STATE_INTRO;
            });

            socket.on("error", () => {
              gameState = STATE_INTRO;
            });
          };

          kontra.canvas.addEventListener("click", function() {
            if (gameState == STATE_CLICK) {
              gameState = STATE_INTRO;
              socket = io({path:location.pathname+'socket.io',upgrade:!1,transports:["websocket"]});
              bindSocket();
            }
          }.bind(this));

          //-------------------------- AUDIO ------------------------
          let playSound = function(params) {
            try {
              var soundURL = jsfxr(params);
              var player = new Audio();
              player.addEventListener('error', function(e) {
                console.log("Error: " + player.error.code);
              }, false);
              player.src = soundURL;
              player.play();
            } catch(e) {}
          }

          let hitSnd = [3,,0.38,,0.2212,0.5172,,-0.5812,,,,,,,,,,,1,,,0.2404,,0.5];
          let slashSnd1 = [3,0.1822,0.3,0.055,0.44,0.83,,-0.0799,-0.013,,,,,,-0.1661,,0.3762,-0.5237,0.8838,0.2939,,0.0684,,0.33];
          let slashSnd2 = [3,0.28,0.27,0.055,0.22,0.35,,-0.0799,-0.013,,,,,,-0.1661,,0.3762,-0.5237,0.71,0.8999,,0.0684,,0.32];
          let blockSnd = [2,,0.21,0.697,0.4208,0.6121,,0.0439,0.0484,,,-0.0533,0.9143,0.8145,-0.0385,0.0019,-0.2199,0.86,0.8623,0.2122,0.0316,,-0.5227,0.57];
          let deathSnd = [3,,0.6875,0.5194,0.6151,0.6789,,0.0063,0.3624,0.0015,-0.0428,0.8318,0.7676,0.2346,-0.4347,0.2729,-0.0128,0.0657,0.9999,-0.1319,,0.051,-0.6832,0.57];
          let victorySnd = [0,0.5898,0.71,0.0001,0.8124,0.59,,-0.02,-0.02,,0.93,-0.6417,,,0.2593,0.1546,0.5485,-0.0023,1,-0.26,0.91,0.83,0.58,0.57];
          let fastSlideSnd = [3,0.36,0.89,0.61,0.95,0.54,,0.52,0.0036,,0.9771,0.453,0.4408,,-0.0252,0.6625,0.0891,0.0016,0.4128,-0.5699,0.6257,0.0698,0.0001,0.57];

          //-------------------------- AUDIO ------------------------

          let NinjaSprite = function(cfg) {
            cfg.keyRightTimer = 0;
            cfg.keyLeftTimer = 0;
            cfg.lastkeyLeftTimer = 0;
            cfg.lastkeyRightTimer = 0;
            cfg.lastKeyTimer = 0;
            cfg.isMoving = false;
            cfg.isRetreating = false;
            cfg.isStanding = true;
            cfg.dontStandAnymore = false;
            cfg.additionalAnimMovement = 0;
            cfg.finalAdditionalMovement = 0;
            cfg.additionalSprFrame = 0;
            cfg.additionalSprName = "",
              cfg.additionalSprIsSword = false;
            cfg.additionalSprPosition = {x: 0, y: 0};
            cfg.lastMove = "";

            kontra.sprite.prototype.init.call(this, cfg);
          };
          NinjaSprite.prototype = Object.create(kontra.sprite.prototype);

          let renderFlipped = function() {
            let ctx = kontra.context;
            if (this.flip) {
              ctx.save();
              ctx.translate(CW, 0);
              ctx.scale(-1, 1);
            }

            this.draw();

            if (this.flip) {
              ctx.restore();
            }

            this.advance();
          };

          NinjaSprite.prototype.render = renderFlipped;

          NinjaSprite.prototype.update = function(dt) {
            this.realX = this.flip ? CW - this.x : this.x;

            this.keyRightTimer += dt;
            this.keyLeftTimer += dt;
            this.lastKeyTimer += dt;

            let isPressedLeft = kontra.keys.pressed(this.keys.a) || (this.flip && this.goesTo == "L");
            let isPressedRight = kontra.keys.pressed(this.keys.d) || (this.flip && this.goesTo == "R");
            let isPressedAtkLow = kontra.keys.pressed(this.keys.w) || (this.flip && this.goesTo == "S");
            let isPressedAtkHigh = kontra.keys.pressed(this.keys.s) || (this.flip && this.goesTo == "W");

            // GUARD statement to avoid doing anything
            if (this.isMoving) {
              let fr = this._ca.frames;
              let hasStoppedAnim = fr[fr.length-1] == STOP_FRAME;

              // do we need to render additional sprites?
              if (this.additionalSprName.length && this._ca._f == this.additionalSprFrame) {
                let spr = this.additionalSprIsSword ? sword : (this.flip ? slashFlip : slash);
                if (this.additionalSprIsSword) spr.flip = this.flip;
                spr.position.x = this.x + this.additionalSprPosition.x;
                spr.position.y = this.y + this.additionalSprPosition.y;
                spr.playAnimation(this.additionalSprName);
                let hitDamage = this.additionalSprName == "atkH" ? HIGH_HIT : LOW_HIT;
                this.additionalSprFrame = 0;
                this.additionalSprName = "";
                this.additionalSprIsSword = false;

                // CHECK COLLISION
                if (spr == slash && isEnemyHit()) {
                  if (DEBUG_GUARD_ACTIVE && enemy.isRetreating || DEBUG_GUARD_ACTIVE && enemy.isStanding) {
                    enemy.isMoving = true;
                    enemy.playAnimation("block");
                    enemy.additionalAnimMovement= -.6;
                    playSound(blockSnd);
                  } else {
                    enemy.isMoving = true;
                    enemy.playAnimation("hit");
                    enemy.additionalAnimMovement= -1;
                    enemyLife.percent -= hitDamage;
                    socket.emit("dmg", hitDamage);
                    playSound(hitSnd);
                  }
                }
                if (spr == slashFlip && isHeroHit()) {
                  if (DEBUG_GUARD_ACTIVE && hero.isRetreating || DEBUG_GUARD_ACTIVE && hero.isStanding) {
                    hero.isMoving = true;
                    hero.playAnimation("block");
                    hero.additionalAnimMovement= -.6;
                    playSound(blockSnd);
                  } else {
                    hero.isMoving = true;
                    hero.playAnimation("hit");
                    hero.additionalAnimMovement = -1;
//                            heroLife.percent -= hitDamage;
                  }
                }
              }

              // lets see if hero has finished attacking / advancing
              if (this._ca._f == fr.length-1) {
                if (hasStoppedAnim || this.dontStandAnymore) {
                  this.x += this.finalAdditionalMovement;
                  this.additionalAnimMovement = 0;
                  this.finalAdditionalMovement = 0;
                  this.x = this.x | 0;
                  if (!this.flip) socket.emit("mov", "", this.x);
                  this.isMoving = false;
                }
              } else {
                this.x += this.additionalAnimMovement;
                // GUARD return if not
                return;
              }
            }

            // CHECK DEATH
            if (heroLife.isDead || enemyLife.isDead) {
              heroLife.isDead = enemyLife.isDead = false;

              let ninjaWhoDied = heroLife.percent <= 0 ? hero : enemy;
              let ninjaWhoWon = heroLife.percent <= 0 ? enemy : hero;

              // death animation
              ninjaWhoDied.isMoving = true;
              ninjaWhoDied.playAnimation("death");
              ninjaWhoDied.additionalSprName = "death";
              ninjaWhoDied.additionalSprFrame = 0;
              ninjaWhoDied.additionalSprPosition = {x: 24, y:15};
              ninjaWhoDied.additionalSprIsSword = true;
              ninjaWhoDied.additionalAnimMovement = 0;
              ninjaWhoDied.finalAdditionalMovement = -6;
              ninjaWhoDied.dontStandAnymore = true;

              bgEnding.enabled = true;

              playSound(deathSnd);
              setTimeout(function() {
                swordFly.x = ninjaWhoDied.x + 24;
                swordFly.y = ninjaWhoDied.y + 15;
                swordFly.playAnimation("fly");
                swordFly.flip = ninjaWhoDied.flip;
                swordFly.enabled = true;
              }.bind(this), 750);

              setTimeout(function() {
                bgEnding.enabled = false;
                playSound(victorySnd);
              }.bind(this), 1500);

              // victory animation
              setTimeout(function() {
                ninjaWhoWon.isMoving = true;
                ninjaWhoWon.playAnimation("victory");
                ninjaWhoWon.additionalSprName = "victory";
                ninjaWhoWon.additionalSprFrame = 2;
                ninjaWhoWon.additionalSprPosition = {x: 12, y:-3};
                ninjaWhoWon.dontStandAnymore = true;
              }.bind(this), 2000);

              setTimeout(function() {
                location.reload(false);
              }, 5000);
            }

            if (this.dontStandAnymore) return;

            // atk low
            if (isPressedAtkLow || (this.flip && this.goesTo == "S")) {
              this.isMoving = true;
              this.isStanding = false;
              this.playAnimation("atkL");
              this.additionalSprName = "atkL";
              this.additionalSprFrame = 2;
              this.additionalSprPosition = {x: 37, y:0};
              this.finalAdditionalMovement = 6;
              if (!this.flip) {
                socket.emit("mov", "S", this.x);
                this.lastMove = "S";
              }
              playSound(slashSnd1);
              return;
            }

            // atk high
            if (isPressedAtkHigh || (this.flip && this.goesTo == "W")) {
              this.isMoving = true;
              this.isStanding = false;
              this.playAnimation("atkH");
              this.additionalSprName = "atkH";
              this.additionalSprFrame = 1;
              this.additionalSprPosition = {x: 37, y:0};
              this.finalAdditionalMovement = 6;
              if (!this.flip) {
                socket.emit("mov", "W", this.x);
                this.lastMove = "W";
              }
              playSound(slashSnd2);
              return;
            }

            // movement
            if (!isPressedRight && !isPressedLeft) {
              this.isStanding = true; // lets assume hero is standing by default (will negate it if he moves)
              this.isRetreating = false; // it's only true if the player walks back
            }
            if (this.keyRightTimer > .02) {
              this.keyRightTimer = 0;
              if (isPressedRight && !isPressedLeft) {
                this.lastkeyRightTimer = this.lastKeyTimer;
                this.x += 1;
                this.isStanding = false;
              }
            }
            if (this.keyLeftTimer > .04) {
              this.keyLeftTimer = 0;
              if (isPressedLeft && !isPressedRight) {
                this.lastkeyLeftTimer = this.lastKeyTimer;
                this.x -= 1;
                this.isStanding = false;
                this.isRetreating = true;
              }
            }

            // fast advance
            if (this.isStanding) {
              let hasAdvanced = false;
              let fastMov = "";
              if ((isPressedLeft && (this.lastKeyTimer - this.lastkeyLeftTimer < DOUBLE_PRESS_LIMIT) && !this.flip) || (this.flip && this.goesTo == "FL")) {
                this.keyLeftTimer = this.lastkeyLeftTimer = 0;
                this.playAnimation("fastL");
                this.x -= FAST_ADVANCE_PX;
                this.additionalAnimMovement = -.4;
                hasAdvanced = true;
                if (!this.flip) this.fastMov = "FL";
              }
              if ((isPressedRight && (this.lastKeyTimer - this.lastkeyRightTimer < DOUBLE_PRESS_LIMIT) && !this.flip) || (this.flip && this.goesTo == "FR")) {
                this.keyRightTimer = this.lastkeyRightTimer = 0;
                this.playAnimation("fastR");
                this.x += FAST_ADVANCE_PX;
                this.additionalAnimMovement = .4;
                hasAdvanced = true;
                if (!this.flip) this.fastMov = "FR";
              }
              if (hasAdvanced) {
                this.isMoving = true;
                this.isStanding = false;
                if (!this.flip) {
                  socket.emit("mov", this.fastMov, this.x);
                } else {
                  this.goesTo = "";
                }
                playSound(fastSlideSnd);
                return;
              }
            }

            // server messages
            if (!this.flip) {
              if (isPressedLeft && this.lastMove != "L") {
                socket.emit("mov", "L", this.x);
                this.lastMove = "L";
              } else if (isPressedRight && this.lastMove != "R") {
                socket.emit("mov", "R", this.x);
                this.lastMove = "R";
              } else if (this.isStanding && this.lastMove != "ST") {
                socket.emit("mov", "ST", this.x);
                this.lastMove = "ST";
              }
            }

            // animation
            if (isPressedRight || isPressedLeft) {
              this.playAnimation("walk");
            } else {
              this.playAnimation("stand");
            }
          };


          // TODO: luisquin remove some keys
          kontra.keys.bind(["g", "h", "w", "s", "left", "right", "up", "down"], function(e) {
            e.preventDefault();
          });

          // std background
          let bgStd = kontra.sprite({
            x: 0,
            y: 0,
            enabled: true,
            image: kontra.assets.images.b1,
            render() {
              if (this.enabled) this.draw();
            }
          });

          // death background
          let bgEnding = kontra.sprite({
            x: 0,
            y: 0,
            enabled: false,
            image: kontra.assets.images.b2,
            render() {
              if (this.enabled) this.draw();
            }
          });

          // sword effect

          let swordSheet = kontra.spriteSheet({
            image: kontra.assets.images.w,
            frameWidth: 25,
            frameHeight: 25,
            animations: {
              hidden: {
                frames: [INVISIBLE_FRAME],
                frameRate: 0
              },
              death: {
                frames: [3, INVISIBLE_FRAME],
                frameRate: 1,
                loop: false
              },
              fly: {
                frames: [0, 1],
                frameRate: 12
              },
              ground: {
                frames: [2],
                frameRate: 0
              }
            }
          });

          let sword = kontra.sprite({
            x: 0,
            y: 0,
            flip: false,
            animations: swordSheet.animations,
            render() {
              renderFlipped.call(this);
            }
          });

          let swordFly = kontra.sprite({
            x: 40,
            y: 55,
            dx: 1,
            dy: -3.5,
            ddy: .1,
            animations: swordSheet.animations,
            enabled: false,
            flip: false,
            update(dt) {
              if (!this.enabled) return;
              this.advance();
              if (this.y > 84) {
                this.dy = this.dx = this.ddy = 0;
                this.y = 84;
                this.x = this.x | 0;
                this.playAnimation("ground");
              }
            },
            render() {
              if (!this.enabled) return;

              renderFlipped.call(this);
            }
          });

          // slash effect

          let slashAnimations = {
            hidden: {
              frames: [INVISIBLE_FRAME],
              frameRate: 0
            },
            victory: {
              frames: [0, INVISIBLE_FRAME],
              frameRate: 6,
              loop: false
            },
            atkL: {
              frames: [1, INVISIBLE_FRAME],
              frameRate: 6,
              loop: false
            },
            atkH: {
              frames: [2, INVISIBLE_FRAME],
              frameRate: 6,
              loop: false
            }
          };

          let slashSheet = kontra.spriteSheet({
            image: kontra.assets.images.e,
            frameWidth: 40,
            frameHeight: 49,
            animations: slashAnimations
          });

          let slash = kontra.sprite({
            x: 0,
            y: 0,
            animations: slashSheet.animations
          });

          let slashSheetFlipped = kontra.spriteSheet({
            image: kontra.assets.images.e,
            frameWidth: 40,
            frameHeight: 49,
            animations: slashAnimations
          });

          let slashFlip = kontra.sprite({
            x: 0,
            y: 0,
            flip: true,
            animations: slashSheetFlipped.animations,
            render() {
              renderFlipped.call(this);
            }
          });

          // life meter

          let renderLifeMeter = function() {
            if (!this.enableDraw) return;

            this.draw();
            let ctx = kontra.context;
            ctx.fillStyle = "#323429";
            ctx.fillRect(this.x, this.y, (this.width*(100 - this.percent)/100) | 0, this.height);
          };

          let updateLifeMeter = function(dt) {
            if (!this.enabled) return;

            if (this.percent < 0) {
              this.percent = 0;
              this.enabled = false;
              this.isDead = true;
            }
            this.timer += dt;
            if (this.timer > .3) {
              this.timer = 0;
              if (this.percent < 30) this.enableDraw = !this.enableDraw;
            }
          }

          let heroLife = kontra.sprite({
            x: 8,
            y: 130,
            image: kontra.assets.images.l,
            percent: 100,
            timer: 0,
            enableDraw: true,
            enabled: true,
            update(dt) {
              updateLifeMeter.call(this, dt);
            },
            render() {
              renderLifeMeter.call(this);
            }
          });

          let enemyLife = kontra.sprite({
            x: 112,
            y: 130,
            image: kontra.assets.images.l,
            percent: 100,
            timer: 0,
            enableDraw: true,
            enabled: true,
            update(dt) {
              updateLifeMeter.call(this, dt);
            },
            render() {
              renderLifeMeter.call(this);
            }
          });

          // hero

          let ninjaAnimations = {
            stand: {
              frames: [0],
              frameRate: 0
            },
            walk: {
              frames: [1, 0],
              frameRate: 3
            },
            fastL: {
              frames: [3, 3, 3, STOP_FRAME],
              frameRate: 8,
              loop: false
            },
            fastR: {
              frames: [4, 4, 4, STOP_FRAME],
              frameRate: 8,
              loop: false
            },
            block: {
              frames: [2, 2, 2, STOP_FRAME],
              frameRate: 8,
              loop: false
            },
            hit: {
              frames: [13, 13, 13, STOP_FRAME],
              frameRate: 8,
              loop: false
            },
            atkH: {
              frames: [7, 8, 8, STOP_FRAME],
              frameRate: 4,
              loop: false
            },
            atkL: {
              frames: [5, 5, 6, STOP_FRAME],
              frameRate: 3,
              loop: false
            },
            victory: {
              frames: [9, 9, 10],
              frameRate: 4,
              loop: false
            },
            death: {
              frames: [11, 11, 12],
              frameRate: 2,
              loop: false
            }
          };

          let heroSheet = kontra.spriteSheet({
            image: kontra.assets.images.g,
            frameWidth: 55,
            frameHeight: 55,
            animations: ninjaAnimations
          });

          let ninjaSheet = kontra.spriteSheet({
            image: kontra.assets.images.g,
            frameWidth: 55,
            frameHeight: 55,
            animations: ninjaAnimations
          });

          let hero = new NinjaSprite({
            x: 20,
            y: 55,
            flip: false,
            animations: heroSheet.animations,
            keys: { a: "a", d: "d", w: "w", s: "s" }
          });

          let enemy = new NinjaSprite({
            x: 20,
            y: 55,
            flip: true,
            goesTo: "",
            animations: ninjaSheet.animations,
            keys: {}
          });

          // intro "waiting" message

          let waiting = kontra.sprite({
            image: kontra.assets.images.i,
            frameWidth: 95,
            frameHeight: 6,
            timer: 0,
            timesToReload: 7,
            enableDraw: false,
            x: 33,
            y: 68,
            update(dt) {
              this.timer += dt;
              if (this.timer > .7) {
                this.timer = 0;
                this.enableDraw = !this.enableDraw;
                if (this.timesToReload-- < 0) location.reload(false);
              }
            },
            render() {
              if (this.enableDraw) this.draw();
            }
          });

          let clickToStart = kontra.sprite({
            image: kontra.assets.images.q,
            frameWidth: 59,
            frameHeight: 6,
            x: 51,
            y: 68
          });

          // clamp sprites
          hero.position.clamp(-20, 0, CW - hero.width, CH - hero.height);
          enemy.position.clamp(-20, 0, CW - hero.width, CH - hero.height);

          let isEnemyHit = function() {
            let a = hero.realX + 34;
            let b = hero.realX + 59;
            let c = enemy.realX - 34;
            let d = enemy.realX - 14;

            return (b>c && b<d) || (a>c && a<d);
          };

          let isHeroHit = function() {
            let a = hero.realX + 16;
            let b = hero.realX + 34;
            let c = enemy.realX - 59;
            let d = enemy.realX - 34;

            return (b>c && b<d) || (a>c && a<d);
          };


          kontra.gameLoop({
            update: function(dt) {
              if (gameState == STATE_INTRO) {
                waiting.update(dt);
              } else if (gameState == STATE_PLAY) {
                let toUpdate = [hero, enemy, slash, slashFlip, sword, swordFly, heroLife, enemyLife];
                toUpdate.forEach(spr => {
                  spr.update(dt);
                });
              }
            },

            render: function() {
              if (gameState == STATE_CLICK) {
                clickToStart.render();
              } else if (gameState == STATE_INTRO) {
                waiting.render();
              } else if (gameState == STATE_PLAY) {
                let toRender = [bgStd, heroLife, enemyLife, bgEnding, slash, slashFlip, swordFly, sword, hero, enemy];
                toRender.forEach(spr => {
                  spr.render();
                }, this);
              }
            }
          }).start();
        }
      }

      let g = new Game();
    </script>
</body>
</html>