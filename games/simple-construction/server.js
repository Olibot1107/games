var v=io;function e(e,r,t){e.emit(r,JSON.stringify(t))}function r(e,r){if(!e)return!1;if(JSON.stringify(e)!==JSON.stringify(r))return!1;for(var t in r){if(void 0===e[t])return!1;if(-1===["map","units","b","time","caps","plus"].indexOf(t)&&e[t]!==r[t])return!1}return e.b.length!==r.b.length?!1:e.map.length!==r.map.length?!1:e.units.length!==r.units.length?!1:!0}function t(e,t){var a=JSON.stringify(t);"userID"===e&&db(e,a),"userID"===e||r(n(e,!0),t)||(x[e]={v:t,t:Date.now()})}function n(e,r){if(x[e]&&!r)return x[e].v;var t=db(e);return"string"==typeof t?JSON.parse(t):t}function a(e,r){return Math.floor(Math.random()*(r-e+1))+e}function s(e){var r,t,n=0;for(r=0;r<e.length;r++)n+=e[r];for(t=a(0,n-1),r=0;r<e.length;r++){if(t<e[r])return r;t-=e[r]}return!1}function i(e,r,t){var n,i,o,u=a(1,3),l=a(1,3);for(n=0;u>n;n++)for(e[r+n]=e[r+n]||[],i=0;l>i;i++)r-n>-1&&t-i>-1&&(o=s([3,0,7,0,0]),0!==o&&(e[r-n][t-i]=o),e[r-n][t-i]||(e[r-n][t-i]=0));return e}function o(e,r,t){return e[r][t]=3,e}function u(e,r,t){var n,i,o,u=a(2,3),l=a(2,3);for(n=0;u>n;n++)for(e[r+n]=e[r+n]||[],i=0;l>i;i++)r-n>-1&&t-i>-1&&(o=s([4,0,0,0,6]),0!==o&&(e[r-n][t-i]=o),e[r-n][t-i]||(e[r-n][t-i]=0));return e}function l(e){var r,t,n;if(0===e)return 0;for(r=y.buildings[e],t=0,n=0;n<r[0].length;n++)t+=Math.floor(.5*r[0][n]);return t}function d(r){var n={userKey:r.id,id:p,map:[],name:f[a(0,9)]+" "+c[a(0,9)],caps:[0,0,0,0],plus:[0,0,0,0],human:0,power:0,crystal:0,scrap:0,worth:0,b:[{x:a(0,25-y.buildings[0][3][0]),y:a(0,25-y.buildings[0][3][1]),w:y.buildings[0][3][0],h:y.buildings[0][3][1],id:0,power:!0,time:Date.now()}],maxed:0,units:[],time:Date.now()};e(r,"l",n),t(p,n),t("userID",++p)}var h,f,c,p,m,g,w,x={};n("userID")||t("userID",0),h=[],f="Andrew,Ivan,Benjamin,Bernard,Julian,Hilda,Cordelia,Martha,Amy,Emilie".split(","),c="Copeland,Burgess,Mendez,Davidson,Barnes,Williamson,Watts,Gregory,Young,Freeman".split(","),p=n("userID"),m=[587.5,18.75,6.25,0,12.5],g=[function(e, r, t){return e[r][t]=0,e},function(e, r, t){return e[r][t]=1,e},i,o,u],v.on("connection",function(r){var a=r.request.connection.remoteAddress.split(":");r.emit("srv-msg",{msg:a[a.length-1]}),r.on("sr",function(a){var i,o,u,h,f,c,w,v,b,x,D,N,I;if("l"===a&&d(r),"object"==typeof a){if(i=0|a[0][0],o=JSON.parse(a[0][1]),u=n(i),!u||u.userKey!==o)return e(r,"e","Unable to login with user data."),d(r);if("m"===a[1]){if(h=u.map,h.length>0)return y.getWallet(u,!0),e(r,"m",u);for(f=0; 25>f; f++)for(h[f]=h[f]||[],c=0; 25>c; c++)w=m,(0===f||0===c||24===f||24===c)&&(w=[m[0],.07*25*25,m[2],m[3],m[4]]),v=s(w),h=g[v](h,f,c);t(i,u),e(r,"m",u)}if("$"===a[1]){for(b=[],x=0; p>x; x++)if(u=n(x),u.worth=0,u.b){for(y.getWallet(u,!0),D=0; D<u.b.length; D++)u.worth+=l(u.b[D].id);u.worth+=Math.floor(.5*u.power),u.worth+=Math.floor(.5*u.crystal),u.worth+=Math.floor(.5*u.scrap),u.worth+=Math.floor(.5*u.human),b.push({name:u.name||u.id,worth:u.worth,buildings:u.b.length}),t(x,u)}b.sort(function(e, r){return(0|r.worth)-(0|e.worth)}),e(r,"$",b)}if("u"===a[1]&&(y.getWallet(u,!0),e(r,"u",u),t(i,u)),"s"===a[1]){for(x=0; x<u.b.length; x++)u.b[x].x===a[2][0]&&u.b[x].y===a[2][1]&&(u.b.splice(x,1),x=u.b.length);e(r,"u",u),t(i,u)}"p"===a[1]&&(N=y.canPlace(u.map,u.b,a[2]),I=y.canBuy(y.getWallet(u,!0),y.buildings[a[2][5]][0]),N&&I&&(u.b.push({x:0|a[2][0],y:0|a[2][1],w:0|a[2][2],h:0|a[2][3],id:0|a[2][5],power:!1,time:Date.now()}),y.handleOverlap(u),y.isPowered(u,u.b),y.purchase(u,a[2][5]),e(r,"u",u)),t(i,u),N===!1&&e(r,"e","Unable to place structure."),I===!1&&e(r,"e","Unable to purchase structure."))}})}),w=0,setInterval(function(){w++;for(var e in x)(Date.now()-x[e].t>3e4||w>10)&&(db(e,JSON.stringify(x[e].v)),delete x[e]);w%=10},3e4)