let PawSpeed = 1.5,
  PawWidth = 210,
  PawHeight = 400,
  PawScale = 1.25;

class Paw extends EventTarget {
  constructor() {
    super();
    this.reset();

    this.m = false;
  }

  reset() {
    this.rX = this.cX = this.dX = WIDTH / 2;
    this.rY = this.cY = this.dY = HEIGHT;
    this.mR = 0;
    this.pR = 0;
    this.cR = 0;
    this.s = PawSpeed * 5;
  }

  reach({ x, y }) {
    if (this.m) {
      return;
    }

    this.dX = x;
    this.dY = y;
    this.mR = getRadius(this);
    this.pR = clampMM(
      getRadius({ cX: this.rX, cY: this.rY, dX: x, dY: y }) + Math.PI / 2,
      -Math.PI / 4,
      Math.PI / 4
    );
    this.m = true;
  }

  move(_shift) {
    if (!this.m) return;

    const shift = _shift * this.s;

    const cmR = Math.cos(this.mR);
    const smR = Math.sin(this.mR);

    this.cX += clampCD(shift * cmR, this.cX, this.dX);
    this.cY += clampCD(shift * smR, this.cY, this.dY);
    this.cR += clampMM(this.pR - this.cR, -0.03, 0.03);

    const mX = this.cX - this.dX;
    const mY = this.cY - this.dY;

    if (!inBox(0, this.cX, WIDTH, 0, this.cY, HEIGHT)) {
      this.reset();
      return;
    }
    if (inBox(-5, mX, 5, -5, mY, 5)) {
      if (inBox(-5, this.cX - this.rX, 5, -5, this.cY - this.rY, 5)) {
        this.reset();
        this.m = false;
      } else {
        const e = new CustomEvent("reached", {
          detail: { x: this.dX, y: this.dY },
        });
        this.dispatchEvent(e);
        this.dX = this.rX;
        this.dY = this.rY;
        this.mR += Math.PI;
        this.s = PawSpeed;
      }
    }
  }

  draw() {
    const scale = PawScale;
    const cpR = Math.cos(this.pR);
    const spR = Math.sin(this.pR);
    const m = new DOMMatrix([
      cpR * scale,
      spR * scale,
      -spR * scale,
      cpR * scale,
      this.cX - ((PawWidth * cpR - PawHeight * spR) * scale) / 2,
      this.cY - ((PawWidth * spR + PawHeight * cpR) * scale) / 2,
    ]);

    ctx.fillStyle = "#000";
    const aP = new Path2D();
    const rect = new Path2D();
    rect.rect(49, 212, 125, (2 * HEIGHT) / scale);
    aP.addPath(rect, m);
    ctx.fill(aP);

    ctx.fillStyle = "#222";
    const pP = new Path2D();
    pP.addPath(
      new Path2D(
        "m195.23321,83.58592c-7.2122,-4.34628 -17.25678,-7.95837 -30.9319,4.88487c8.50695,-12.1795 15.51858,-25.66742 8.13768,-40.46374c-4.59001,-11.28369 -22.00313,-18.01405 -33.95696,-15.34641c-9.22463,3.18014 -19.74589,14.2259 -22.32911,33.95567c-2.99764,-11.86397 -8.05135,-22.60645 -16.28263,-32.78818c-6.24402,-6.30707 -14.99203,-13.22204 -34.43298,-9.36829c-11.50158,3.78784 -23.08568,26.05005 -11.91825,60.67397c-5.53697,-7.39657 -26.97844,-25.85081 -42.29019,3.37065c-5.54067,7.05117 -8.98946,27.94737 11.17618,43.90124c27.81061,18.5906 26.6194,38.20102 26.43179,80.37181l-0.11181,26.70529l4.01803,18.74771l10.49382,-20.27247c3.0939,5.22899 0.22824,17.73066 9.28171,15.68696c2.41209,-1.20196 -0.22631,10.4243 4.20597,15.18191c4.971,-16.65644 9.33594,-30.88864 9.7615,-55.42383l9.32104,21.47497l1.69481,-3.07037l5.49385,15.48494c4.09744,0.57747 3.14441,-9.55209 5.32267,-9.47967c4.10258,-0.53618 5.57892,11.85687 12.61078,11.4217c4.37194,-41.07471 14.29942,-40.33144 22.81276,-0.49743l4.2987,-19.67604c3.12742,3.07913 6.25485,5.65321 10.29135,-2.58074c3.76022,5.90842 4.18713,21.61478 15.22005,28.02825l0.14295,-42.32205c0.58022,-18.41021 -2.76479,-35.69892 2.86216,-55.23063c1.41484,-4.83216 6.19418,-11.941 14.33799,-15.05724c10.12784,-4.35157 12.97439,-10.37865 16.00616,-20.20297c2.98838,-10.70964 3.21343,-14.57245 1.52575,-21.15774c-1.68768,-6.58529 -5.82863,-12.46964 -13.19387,-16.95213l0,-0.00001z"
      ),
      m
    );
    ctx.fill(pP);

    ctx.fillStyle = "#000";
    const sP = new Path2D();
    sP.addPath(
      new Path2D(
        "m54.1548,150.91483c5.48971,-2.75971 26.13082,-7.94364 40.10532,-3.27917c13.25565,7.87103 57.26865,6.65122 48.85781,12.70408c-10.40409,7.31933 -29.89902,2.51754 -43.03037,7.86718c-9.61539,1.44518 -19.23078,1.0722 -26.57347,-4.75529c-5.54401,-7.81527 -25.78488,-8.6609 -19.35929,-12.5368z"
      ),
      m
    );
    sP.addPath(
      new Path2D(
        "m97.54315,184.78247c5.48971,-2.75971 43.84511,0.9135 57.8196,5.57798c13.25565,7.87103 16.69722,6.07979 8.28637,12.13265c-10.40409,7.31933 -35.04188,-13.76818 -61.6018,3.86718c-9.61539,1.44518 -29.5165,-0.07066 -36.85918,-5.89815c-5.54401,-7.81527 25.92941,-11.80376 32.355,-15.67966z"
      ),
      m
    );
    sP.addPath(
      new Path2D(
        "m111.23916,105.23722c5.48971,-2.75971 -1.80567,-30.80077 12.16882,-26.13629c13.25565,7.87103 15.68138,16.49248 7.27053,22.54535c-10.40409,7.31933 20.8946,30.77149 7.76325,36.12113c-9.61539,1.44518 -32.56411,5.19918 -39.90679,-0.62831c-5.54401,-7.81527 6.27859,-28.02597 12.70418,-31.90187z"
      ),
      m
    );
    sP.addPath(
      new Path2D(
        "m69.80415,103.18179c5.48971,-2.75971 -1.80567,-28.53662 12.16882,-23.87214c8.72735,2.58801 10.77572,-8.79053 16.70449,-3.11503c8.46383,12.9797 -4.76578,36.80922 -17.89712,42.15887c-9.61539,1.44518 -33.69618,-7.63101 -41.03887,-13.4585c-5.54401,-7.81527 23.63708,2.16271 30.06267,-1.7132z"
      ),
      m
    );
    sP.addPath(
      new Path2D(
        "m156.2149,102.5314c5.48971,-2.75971 17.00039,0.31722 30.97488,4.9817c13.25565,7.87103 0.74694,10.56426 -7.66391,16.61712c-10.40409,7.31933 -8.59468,-6.17811 -21.72603,-0.82847c-9.61539,1.44518 -6.18731,0.20263 -13.52999,-5.62486c-5.54401,-7.81527 5.51945,-11.26959 11.94505,-15.1455z"
      ),
      m
    );
    ctx.fill(sP);

    ctx.fillStyle = "#fff";
    const cP = new Path2D();
    cP.addPath(
      new Path2D(
        "m22.76333,85.31946c-1.56029,3.04964 -8.01419,15.46099 -12.34043,7.23403c-6.80851,-11.20567 -11.48936,-25.1773 -10.21277,-29.14894c8.79433,2.62412 10.56738,17.58866 22.5532,21.9149l0,0.00001z"
      ),
      m
    );
    cP.addPath(
      new Path2D(
        "m66.16758,30.00031c4.11347,0.99291 17.16312,-0.56738 12.34042,-4.68086c-5.53191,-13.12057 -14.89362,-25.39007 -19.14894,-25.31915c-2.41135,6.17021 9.43263,18.72341 6.80852,30.00001z"
      ),
      m
    );
    cP.addPath(
      new Path2D(
        "m151.48673,38.51095c3.47517,1.70213 11.20567,8.93617 11.70212,2.55318c2.83688,-20.6383 0.78014,-25.74468 -1.70213,-28.7234c-4.82269,3.19149 -3.04964,20.21277 -9.99999,26.17022z"
      ),
      m
    );
    cP.addPath(
      new Path2D(
        "m192.9761,92.12797c2.76595,3.12057 8.93616,9.85815 10.85105,5.53191c3.75887,-7.58865 7.30496,-24.11347 4.89362,-28.51064c-5.24822,1.9149 -6.66666,17.44681 -15.74467,22.97873z"
      ),
      m
    );
    ctx.fill(cP);
  }
}
