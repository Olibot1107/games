"use strict";var o="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},t={exports:{}};!function(t){!function(o){function s(o){if(e=b(s),!(o<n+f)){for(c+=o-n,n=o,w(o,c),o>u+i&&(r=p*l*1e3/(o-u)+(1-p)*r,u=o,l=0),l++,d=0;c>=a;)if(g(a),c-=a,++d>=240){h=!0;break}M(c/a),v(r,h),h=!1}}var e,a=1e3/60,c=0,n=0,r=60,p=.9,i=1e3,u=0,l=0,d=0,f=0,y=!1,x=!1,h=!1,m="object"==typeof window?window:o,b=m.requestAnimationFrame||function(){var o,t,s=Date.now();return function(e){return o=Date.now(),t=Math.max(0,a-(o-s)),s=o+t,setTimeout((function(){e(o+t)}),t)}}(),k=m.cancelAnimationFrame||clearTimeout,S=function(){},w=S,g=S,M=S,v=S;o.MainLoop={getSimulationTimestep:function(){return a},setSimulationTimestep:function(o){return a=o,this},getFPS:function(){return r},getMaxAllowedFPS:function(){return 1e3/f},setMaxAllowedFPS:function(o){return void 0===o&&(o=1/0),0===o?this.stop():f=1e3/o,this},resetFrameDelta:function(){var o=c;return c=0,o},setBegin:function(o){return w=o||w,this},setUpdate:function(o){return g=o||g,this},setDraw:function(o){return M=o||M,this},setEnd:function(o){return v=o||v,this},start:function(){return x||(x=!0,e=b((function(o){M(1),y=!0,n=o,u=o,l=0,e=b(s)}))),this},stop:function(){return y=!1,x=!1,k(e),this},isRunning:function(){return y}},null!==t&&(t.exports=o.MainLoop)}(o)}(t);var s=t.exports;function e(o,t){return{x:o||0,y:t||0}}const a=(o,t)=>(o.x=t.x,o.y=t.y,o),c=(o,t,s)=>(o.x=t,o.y=s,o),n=(o,t,s)=>(o.x=t.x+s.x,o.y=t.y+s.y,o),r=(o,t,s)=>(o.x=t.x-s.x,o.y=t.y-s.y,o),p=(o,t)=>o.x*t.x+o.y*t.y,i=(o,t,s)=>(o.x=t.x*s,o.y=t.y*s,o),u=(o,t)=>{const s=o.x-t.x,e=o.y-t.y;return Math.sqrt(s*s+e*e)},l=(o,t)=>{const s=t.x,e=t.y;let a=s*s+e*e;return a>0&&(a=1/Math.sqrt(a),o.x=t.x*a,o.y=t.y*a),o},d={x:0,y:0},f={x:0,y:0},y={x:0,y:0},x={x:0,y:0},h=(o,t,s,e,a,p,i,u)=>{const l=((o,t)=>{const s=o.x-t.x,e=o.y-t.y;return s*s+e*e})(o.cpos,e.cpos),h=t+a;r(d,o.cpos,o.ppos),r(f,e.cpos,e.ppos),r(y,o.cpos,e.cpos);const m=Math.sqrt(l);let b=(m-h)/m;0===m&&(b=1);const k=s>0?s:1,S=p>0?p:1,w=k+S;if(x.x=y.x*b*(S/w),x.y=y.y*b*(S/w),s>0&&r(o.cpos,o.cpos,x),x.x=y.x*b*(k/w),x.y=y.y*b*(k/w),p>0&&n(e.cpos,e.cpos,x),!i)return;const g=(u=u||1)*(y.x*d.x+y.y*d.y)/(l||1),M=u*(y.x*f.x+y.y*f.y)/(l||1);d.x+=(M*y.x-g*y.x)/(k||1),f.x+=(g*y.x-M*y.x)/(S||1),d.y+=(M*y.y-g*y.y)/(k||1),f.y+=(g*y.y-M*y.y)/(S||1),s>0&&c(o.ppos,o.cpos.x-d.x,o.cpos.y-d.y),p>0&&c(e.ppos,e.cpos.x-f.x,e.cpos.y-f.y)},m=e(),b=e(),k=e(),S=e();const w=e(),g=e();const M=e(),v=e(),T=e(),E=e(),I=e(),A=e();function $(o,t,s,e){r(T,o.cpos,o.ppos),l(E,T),i(I,E,t),n(A,I,o.cpos);return!!function(o,t,s,e,a){r(w,t,o),r(g,e,s);const c=(-w.y*(o.x-s.x)+w.x*(o.y-s.y))/(-g.x*w.y+w.x*g.y),n=(g.x*(o.y-s.y)-g.y*(o.x-s.x))/(-g.x*w.y+w.x*g.y);return c>=0&&c<=1&&n>=0&&n<=1&&(a.x=o.x+n*w.x,a.y=o.y+n*w.y,!0)}(A,o.ppos,s,e,M)&&(r(v,A,M),r(o.cpos,o.cpos,v),r(o.ppos,o.ppos,v),!0)}var B,D;!function(o){o.Message="A",o.Objects="B",o.Creation="C",o.Deletion="D",o.Scored="E",o.Positions="F",o.Scoreboard="G"}(B||(B={})),function(o){o.Message="A",o.Click="B"}(D||(D={}));let F="",P=1,j=0,N=0;const q=[1,8],C=new Map,z=["#fff","#ffff00","#0000ff","#ff0000","#aa00aa","#ffaa00","#1f952f","#550000","#1a191e"],O=[[e(64,100),e(64,580)],[e(616,100),e(616,580)],[e(100,64),e(580,64)],[e(100,616),e(580,616)]],W=[[e(0,140),e(140,0)],[e(540,0),e(680,140)],[e(0,540),e(140,680)],[e(680,540),e(540,680)]];function G(){const o=P;return!(o<Number.MAX_SAFE_INTEGER)||P++,o}function L(o){return o[Math.floor(Math.random()*o.length)]}function R(o,t){const s={id:G(),cpos:e(),ppos:e(),acel:e(),radius:1,mass:1,value:0,label:`${L(":=")}${L("POD)]")}`,lastTouchedTimestamp:Date.now(),...t};return _(s),o.balls.set(s.id,s),o.sockets.forEach((o=>o.emit(B.Creation,s))),s}function U(){return 78+Math.floor(524*Math.random())}function _(o){const t=U(),s=U();o.cpos=e(t,s),o.ppos=e(t,s)}function J(o){o.data.table&&(o.data.ball=R(o.data.table,{radius:14,ownerSocketId:o.id,color:V(),value:9}))}function X(o){return C.forEach((t=>function(o,t){return t.sockets.forEach((t=>t.emit(B.Message,o)))}(o,t)))}function H(o){O.forEach((([t,s])=>{$(o,o.radius,t,s)&&function(o,t,s,c,d,f,y,x,w){r(b,f.cpos,c.cpos),l(m,b),r(k,o.cpos,c.cpos);const g=p(b,k),M=p(b,b),v=Math.sqrt(M);if(g<0||g>M)return;const T=g/M,E=1-T;if(i(S,m,T*v),n(S,S,c.cpos),u(S,o.cpos)>t)return;const I=E*s,A=T*s,$={cpos:e(),ppos:e()},B={cpos:e(),ppos:e()};i($.cpos,m,T*v),r($.cpos,o.cpos,$.cpos),i($.ppos,m,T*v),r($.ppos,o.ppos,$.ppos),i(B.cpos,m,E*v),n(B.cpos,o.cpos,B.cpos),i(B.ppos,m,E*v),n(B.ppos,o.ppos,B.ppos);const D={cpos:e(),ppos:e()},F={cpos:e(),ppos:e()};a(D.cpos,$.cpos),a(D.ppos,$.ppos),a(F.cpos,B.cpos),a(F.ppos,B.ppos),h($,t,I,c,0,d,x,w),h(B,t,A,f,0,y,x,w);const P={cpos:e(),ppos:e()},j={cpos:e(),ppos:e()};r(P.cpos,$.cpos,D.cpos),r(j.cpos,B.cpos,F.cpos),i(P.cpos,P.cpos,E),i(j.cpos,j.cpos,T),n(o.cpos,o.cpos,P.cpos),n(o.cpos,o.cpos,j.cpos),x&&(r(P.ppos,$.ppos,D.ppos),r(j.ppos,B.ppos,F.ppos),i(P.ppos,P.ppos,E),i(j.ppos,j.ppos,T),n(o.ppos,o.ppos,P.ppos),n(o.ppos,o.ppos,j.ppos))}(o,o.radius,o.mass,{cpos:t,ppos:t},-1,{cpos:s,ppos:s},-1,!0,.9)}))}function K(o,t){t.balls.has(o.id)&&(t.balls.delete(o.id),t.sockets.forEach((t=>t.emit(B.Deletion,o.id)))),0==function(o){return Array.from(o.balls.values()).filter((o=>!o.ownerSocketId)).length}(t)&&Y(t)}function Q(o){C.forEach((t=>{Array.from(t.balls.values()).forEach(((s,e,a)=>{var n,r;!function(o){(o.cpos.x<0||o.cpos.x>680||o.cpos.y<0||o.cpos.y>680)&&_(o)}(s),r=o,(n=s).cpos.x+=n.acel.x*r*r*.001,n.cpos.y+=n.acel.y*r*r*.001,c(n.acel,0,0),a.filter((o=>{return s!==o&&(e=o,((o,t,s,e,a,c)=>{const n=e-o,r=a-t,p=s+c;return n*n+r*r<p*p})((t=s).cpos.x,t.cpos.y,t.radius,e.cpos.x,e.cpos.y,e.radius));var t,e})).forEach((o=>{return e=o,(t=s).ownerSocketId||e.ownerSocketId?(t.ownerSocketId&&(e.lastTouchedBySocketId=t.ownerSocketId),e.ownerSocketId&&(t.lastTouchedBySocketId=e.ownerSocketId)):t.lastTouchedTimestamp>e.lastTouchedTimestamp?e.lastTouchedBySocketId=t.lastTouchedBySocketId:t.lastTouchedBySocketId=e.lastTouchedBySocketId,t.lastTouchedTimestamp=e.lastTouchedTimestamp=Date.now(),void h(t,t.radius,t.mass,e,e.radius,e.mass,!0,.9);var t,e})),H(s),function(o,t){W.forEach((([s,e])=>{if($(o,o.radius,s,e)){if(K(o,t),o.ownerSocketId){const s=t.sockets.get(o.ownerSocketId);if(s){const t=-o.value;s.data.score=Math.max(0,s.data.score+t),s.emit(B.Scored,t,o.cpos.x,o.cpos.y),J(s)}}if(o.lastTouchedBySocketId){const s=t.sockets.get(o.lastTouchedBySocketId);s&&(s.data.score=s.data.score+o.value,s.emit(B.Scored,o.value,o.cpos.x,o.cpos.y))}}}))}(s,t),(o=>{const t=2*o.cpos.x-o.ppos.x,s=2*o.cpos.y-o.ppos.y;c(o.ppos,o.cpos.x,o.cpos.y),c(o.cpos,t,s)})(s)}))}))}function V(){const o=o=>Math.floor(Math.random()*(o+1)),[t,s,e]=[o(255),o(255),o(255)];return`#${t.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}${e.toString(16).padStart(2,"0")}`}function Y(o){const[t,s]=q;for(let e=t;e<=s;e++)R(o,{radius:14,value:e,label:`${e}`,color:z[e]})}function Z(o,t){t.sockets.set(o.id,o),o.data.table=t,J(o),o.emit(B.Objects,Array.from(t.balls.values())),X(`游닉 ${o.data.nickname} joined Table ${t.id}!`)}function oo(o,t){t&&(function(o){o.data.table&&o.data.ball&&(K(o.data.ball,o.data.table),o.data.ball=void 0)}(o),t.sockets.delete(o.id),o.data.table=void 0,t.sockets.size||function(o){Array.from(o.balls.values()).forEach((t=>K(t,o))),C.delete(o.id)}(t))}function to(){const o={id:G(),sockets:new Map,balls:new Map};return C.set(o.id,o),Y(o),o}s.setUpdate((function(o){Q(o),j+=o,j>125&&(j-=125,Array.from(C.values()).filter((o=>o.balls.size)).forEach((o=>{const t=Array.from(o.balls.values()).reduce(((o,t)=>(o.push([t.id,Math.trunc(t.cpos.x),Math.trunc(t.cpos.y)]),o)),[]);o.sockets.forEach((o=>{o.emit(B.Positions,t)}))}))),N+=o,N>1e3&&(N-=1e3,function(){const o=new Map;C.forEach((t=>{const s=Array.from(t.sockets.values()).sort(((o,t)=>t.data.score-o.data.score)).reduce(((o,s)=>(o.push([s.data.nickname,s.data.score,t.id]),o)),[]);o.set(t.id,s)}));const t=[];o.forEach((o=>t.push(...o))),t.sort((([,o],[,t])=>t-o));const s=JSON.stringify(t);F!==s&&(F=s,C.forEach((s=>{s.sockets.forEach((s=>{let e=[];s.data.table&&o.has(s.data.table.id)&&(e=o.get(s.data.table.id)),s.emit(B.Scoreboard,t,e)}))})))}())})).start();var so={io:function(o){o.data.nickname=`Player ${G()}`,o.data.score=0,Z(o,Array.from(C.values()).find((o=>o.sockets.size<4))??to()),function(o){o.on("disconnect",(()=>function(o){if(!o.data.table)return;oo(o,o.data.table)}(o))),o.on(D.Message,(t=>function(o,t){if(o.startsWith("/nick ")){const s=o.replace("/nick ","").trim().substring(0,21);s.length&&(X(`游닉 ${t.data.nickname} is now known as ${s}!`),t.data.nickname=s)}else if(o.startsWith("/newtable"))oo(t,t.data.table),Z(t,to());else if(o.startsWith("/jointable ")){const s=Number(o.replace("/jointable ","").trim());isNaN(s)||!C.has(s)?t.emit(B.Message,"游닉 Table not found!"):C.get(s)===t.data.table?t.emit(B.Message,`游닉 Already on table ${s}!`):C.get(s).sockets.size>=4?t.emit(B.Message,"游닉 Table is full!"):(oo(t,t.data.table),Z(t,C.get(s)))}else X(`游눫 ${t.data.nickname}: ${o}`)}(t,o))),o.on(D.Click,((t,s)=>function(o,t,s){if(!s.data.ball)return;const a=e();r(a,e(o,t),s.data.ball.cpos),l(a,a);const c=u(e(o,t),s.data.ball.cpos)/680*20;i(a,a,c),n(s.data.ball.acel,s.data.ball.acel,a)}(t,s,o)))}(o)}};module.exports=so;
