let TILE_WIDTH=32,TILE_HEIGHT=32,PLAYER_WIDTH=26,PLAYER_HEIGHT=40,BULLET_SIZE=14,BULLET_OFFSET_Y=-15,HIT_RADIUS=10,CAT_WIDTH=26,CAT_HEIGHT=22,MAP_SIZE=256,BLOCKS=8,BLOCK_SIZE=32,FONTS='"Press Start 2P", "VT323", "Consolas", "monospace"',BLUE="#3ae1f4ff",BRIGHT_BLUE="#83f3ffff",RED="#ff5c5c",GREY="#d3d3d3ff",maxShieldPoints=3,shieldRegen=.004,shieldRecoverMax=.5,speed=4,slowSpeed=2.5,dashSpeed=10,dashTimeMax=.25,dashPowerCost=100,catPowerMax=300,catPowerRegen=100/126,catPowerRegenPerBullet=0,titleShowTimeMax=3,convertRadius=100,upgradeScore=1e5,upgradeRadius=8,tier1Enemies=[1,2,3,8,12,21,22,25],tier2Enemies=[4,5,6,7,9,11,18,23,24],tier3Enemies=[10,13,14,15,16,17,19,20,26],tier1StageSpawns=[[2,3],[2,4],[3,4]],tier2StageSpawns=[[1,1],[1,2],[1,2]],tier3StageSpawns=[[0,1],[0,1],[1,1]],imgDict={},canvas=(["brick1","brick2","player","cat","enemy","bullet1","bullet2","bulletc","life","shield"].forEach(e=>{var t=new Image;t.src=`assets/${e}.png`,imgDict[e]=t}),document.getElementById("game")),ctx=canvas.getContext("2d"),map=Array.from({length:MAP_SIZE},()=>Array.from({length:MAP_SIZE},()=>"")),gameState=0,stage=0,currFrame=0,score=0,continued=!1,practicing=!1,highScore=0,unlockProgress=0,clearStatus=0,offsetX=0,offsetY=0,hitPoints=3,shieldPoints=3,shieldRecoverCache=0,invTime=0,playerX=512,playerY=512,playerCatStatus=!1,playerBlockX=0,playerBlockY=0,currLevel=0,dashX=0,dashY=0,dashTime=0,catPower=0,maskAlpha=1,moveFlags=[],enemies=[],bullets=[],texts=[],particles=[],lastProgressDraw=0,lastRatio=0,titleShowTime=0,mouseLeftDown=!1,mouseRightDown=!1,mouseDownX=0,mouseDownY=0,keyState={};function restartMap(){playerX=512,playerY=512,bullets=[],enemies=[],map=Array.from({length:MAP_SIZE},()=>Array.from({length:MAP_SIZE},()=>"")),catPower=catPowerMax,moveFlags=[];let a=0,o=0,e=0;for(;a<BLOCKS&&o<BLOCKS;){for(let t=0;t<BLOCK_SIZE;t++)for(let e=0;e<BLOCK_SIZE;e++)map[o*BLOCK_SIZE+t][a*BLOCK_SIZE+e]=0==e||0==t||e==BLOCK_SIZE-1||t==BLOCK_SIZE-1?"brick1":"brick2";if(0!==a||0!==o)if(e)for(let e=BLOCK_SIZE/2-2;e<BLOCK_SIZE/2+2;e++)map[o*BLOCK_SIZE+e].splice(a*BLOCK_SIZE-1,2,"brick2","brick2");else for(let e=BLOCK_SIZE/2-2;e<BLOCK_SIZE/2+2;e++)[map[o*BLOCK_SIZE-1][a*BLOCK_SIZE+e],map[o*BLOCK_SIZE][a*BLOCK_SIZE+e]]=["brick2","brick2"];if(0===a&&0===o&&(firstMoveRightFlag=e),e=Math.random()<.5,moveFlags.push(e),a===BLOCKS-1&&(e=!1),(e=o===BLOCKS-1?!0:e)?a++:o++,a+o===1&&enemies.push({type:1,x:(a+.5)*BLOCK_SIZE*TILE_WIDTH,y:(o+.5)*BLOCK_SIZE*TILE_HEIGHT,hp:20,maxHp:20}),2<=a+o&&a+o<2*BLOCKS-2){function t(t,a){var o=[];for(let e=0;e<a;e++)o.push(t[Math.floor(Math.random()*t.length)]);return o}var r=Math.floor(stage/2),s=t(tier1Enemies,ranInt(tier1StageSpawns[r][0],tier1StageSpawns[r][1])),i=t(tier2Enemies,ranInt(tier2StageSpawns[r][0],tier2StageSpawns[r][1])),r=t(tier3Enemies,ranInt(tier3StageSpawns[r][0],tier3StageSpawns[r][1])),l=s.concat(i,r);for(let e=0;e<l.length;e++){var n=(a*BLOCK_SIZE+12+Math.random()*(BLOCK_SIZE-24))*TILE_WIDTH,h=(o*BLOCK_SIZE+12+Math.random()*(BLOCK_SIZE-24))*TILE_HEIGHT;enemies.push({type:l[e],x:n,y:h,hp:30})}}else a+o===2*BLOCKS-2&&enemies.push({type:114+Math.floor(stage/2),x:(a+.5)*BLOCK_SIZE*TILE_WIDTH,y:(o+.5)*BLOCK_SIZE*TILE_HEIGHT,hp:1500,maxHp:1500})}}function update(){if(currFrame++,playColdDown=Math.max(0,playColdDown-1/60),0<hitPoints){let e,t;if(0<dashTime)e=dashX,t=dashY,dashTime-=1/60;else{var a=keyState.a?-1:0+keyState.d?1:0,o=keyState.w?-1:0+keyState.s?1:0,r=Math.hypot(a,o)||1;if(0===r)return;e=a*((mouseLeftDown?slowSpeed:speed)/r),t=o*((mouseLeftDown?slowSpeed:speed)/r)}getCollision(playerX+=e,playerY)&&(playerX-=e),playerY+=t,getCollision(playerX,playerY)&&(playerY-=t)}if(((playerCatStatus=0<dashTime)||0<invTime)&&0<hitPoints)for(var e of bullets){var t=e.x-playerX,s=e.y-playerY;!e.converted&&Math.hypot(t,s)<=getRadius()&&(0<invTime?(e.lifeTime=0,particles.push({type:4,x:e.x,y:e.y,velX:4*(Math.random()-.5),velY:4*(Math.random()-.5),lifeTime:.5}),playSound("parry")):(e.converted=!0,shieldRecoverCache<shieldRecoverMax&&(0<Math.floor(shieldPoints+shieldRegen)-Math.floor(shieldPoints)&&shieldPoints<3&&(texts.push({text:"Shield Recover",x:playerX,y:playerY,lifeTime:1,color:BLUE}),playSound("tip")),shieldRecoverCache+=shieldRegen,shieldPoints+=shieldRegen),playSound("parry"),particles.push({type:2,x:e.x,y:e.y,velX:4*(Math.random()-.5),velY:4*(Math.random()-.5),lifeTime:.5}),catPower+=catPowerRegenPerBullet,e.lifeTime=5,score+=15))}else catPower=Math.min(catPowerRegen+catPower,catPowerMax);invTime=Math.max(invTime-1/60,0),shieldPoints=Math.min(shieldPoints,maxShieldPoints),shieldRecoverCache=Math.max(shieldRecoverCache-1/60,0),currLevel=2*BLOCKS;for(var i of enemies){var l=Math.floor(i.x/TILE_WIDTH/BLOCK_SIZE),n=Math.floor(i.y/TILE_HEIGHT/BLOCK_SIZE),h=(currLevel=Math.min(currLevel,l+n),getAngleTowardsPlayer(i.x,i.y)),c=2*Math.random()*Math.PI,f=currFrame%1500;if(playerBlockX===l&&playerBlockY===n)if(1===i.type&&currFrame%70%6==0&&currFrame%70<30)enemyShoot(i.x,i.y,[h],[3]);else if((2===i.type||3===i.type)&&currFrame%70%5==0&&currFrame%70<25){l=2===i.type?[h-PI2ToX(24),h+PI2ToX(24)]:[h,h-PI2ToX(36),h+PI2ToX(36)];enemyShoot(i.x,i.y,l,[2])}else if(4===i.type&&currFrame%80<25)enemyShoot(i.x,i.y,[h+currFrame%80*PI2ToX(48),h-currFrame%80*PI2ToX(48)],[2],[2.5]);else if((5===i.type||6===i.type||7===i.type)&&currFrame%80==0||(13===i.type||14===i.type)&&currFrame%100<=30&&currFrame%10==0)for(let e=0;e<24;e++)enemyShoot(i.x,i.y,[h+e*PI2ToX(24)],[13<=i.type?[4,5][i.type-13]:[1,4,5][i.type-5]],[4.5]);else if(8<=i.type&&i.type<=11&&currFrame%80==0){var y=[[h],[h,h+Math.PI],[h-Math.PI/3,h+Math.PI/3],[c,c+Math.PI/2,c+Math.PI,c+Math.PI/2*3]][i.type-8],d=[[1],[5],[5,6],[1]][i.type-8];for(let e=0;e<15;e++)enemyShoot(i.x,i.y,y,d,[5-.25*e])}else if(12===i.type&&currFrame%60==0)for(let e=0;e<16;e++)enemyShoot(i.x+45*Math.cos(e*Math.PI/8),i.y+45*Math.sin(e*Math.PI/8),[h],[1],[3]);else if(15===i.type&&currFrame%90<=45&&currFrame%6==0){n=2*Math.random()*Math.PI;enemyShoot(i.x,i.y,[n,n,n],[2,2,2],[2.5,3.5,4.5])}else if(16===i.type&&currFrame%100<=60&&currFrame%3==0)enemyShoot(i.x,i.y,[h+ranAngle(-PI2ToX(24),PI2ToX(24))],[2],[2+2.5*Math.random()]);else if(17===i.type&&currFrame%100<=60&&currFrame%20==0)for(let e=0;e<8;e++)enemyShoot(i.x,i.y,[h+ranAngle(-PI2ToX(10),PI2ToX(10))],[2],[3+1.5*Math.random()]);else if(18===i.type&&currFrame%75==0)for(let e=0;e<6;e++)enemyShoot(i.x,i.y,[h+e*PI2ToX(6)],[7],[2.8]);else if(19!==i.type&&20!==i.type||currFrame%80!=0){if(21===i.type&&currFrame%60==0)for(let e=0;e<15;e++)enemyShoot(i.x-25*Math.sin(h),i.y+25*Math.cos(h),[h],[1],[5-.25*e]),enemyShoot(i.x+25*Math.sin(h),i.y-25*Math.cos(h),[h],[1],[5-.25*e]);else if(22===i.type&&currFrame%75==0)for(let t=4;1<=t;t--)for(let e=-t;e<=t;e++)enemyShoot(i.x,i.y,[h+e/t*PI2ToX(18)],[2],[2+.8*t]);else if((23===i.type||24===i.type)&&currFrame%110<=40)enemyShoot(i.x,i.y,[h+currFrame%90*PI2ToX(20)],[23===i.type?2:5],[4.5]);else if(25===i.type&&currFrame%70%6==0&&currFrame%70<30)enemyShoot(i.x,i.y,[h],[8]);else if(26===i.type&&currFrame%120==0)for(let e=0;e<7;e++)enemyShoot(i.x,i.y,[h+ranAngle(-PI2ToX(4),PI2ToX(4))],[8],[3+1.5*Math.random()]);else if(114===i.type){if(f<400){if(f%2==0&&enemyShoot(i.x,i.y,[h+f*Math.PI/30],[4],[2.5]),f%40==0)for(let e=0;e<24;e++)enemyShoot(i.x,i.y,[h+e*Math.PI/12],[200<=f?5:6],[4.5])}else if(400<=f&&f<800){if(f%40==0)for(let e=0;e<16;e++){var x=i.x+45*Math.cos(e*Math.PI/8),m=i.y+45*Math.sin(e*Math.PI/8);enemyShoot(x,m,[getAngleTowardsPlayer(x,m)],[2],[2.5])}if(f%60==0){var p=Math.PI/4.5*Math.random(),v=Math.PI/4.5*Math.random();for(let e=0;e<15;e++)enemyShoot(i.x,i.y,[h,h+p,h-v],[1],[5-.25*e])}}else if(800<=f&&f<1200){if(f%3==0&&enemyShoot(i.x,i.y,[h+Math.random()*Math.PI/6-Math.PI/12],[2],[2+2.5*Math.random()]),f%120==0)for(let e=0;e<15;e++)enemyShoot(i.x,i.y,[c,c+Math.PI/2,c+Math.PI,c+Math.PI/2*3],[1],[5-.25*e])}else if(1200<=f){if(f%3==0)for(let e=0;e<12;e++)enemyShoot(i.x,i.y,[h+e*Math.PI/6],[2,5,6][e%3],[4.5]);if(f%90==0)for(let e=0;e<15;e++)enemyShoot(i.x,i.y,[h-Math.PI/2.5,h+Math.PI/2.5],[5,6],[5-.25*e])}}else if(115===i.type){if(f<=600&&f%45==0){var g=ranAngle(-PI2ToX(20),PI2ToX(20));for(let e=0;e<10;e++){var u=h+PI2ToX(10)*e+g;for(let e=0;e<20;e++)enemyShoot(i.x+50*Math.cos(e*Math.PI/10),i.y+50*Math.sin(e*Math.PI/10),[u],[2],[2.5])}}if(200<=f&&f<=800){if(f%48==0)for(let e=0;e<16;e++){var T=i.x+50*Math.cos(e*Math.PI/8),S=i.y+50*Math.sin(e*Math.PI/8);enemyShoot(T,S,[getAngleTowardsPlayer(T,S)],[3],[8])}if(f%3==0)for(let e=0;e<12;e++)enemyShoot(i.x,i.y,[e*Math.PI/6+Math.sin(f/300*PI2ToX(2))],[2],[2])}if(800<=f&&f<1350&&(f%2==0&&enemyShoot(i.x,i.y,[h+f/70*PI2ToX(1)+ranAngle(-PI2ToX(50),PI2ToX(50)),h-f/70*PI2ToX(1)+ranAngle(-PI2ToX(50),PI2ToX(50))],[2],[2.5]),f%120==0))for(let e=0;e<15;e++)enemyShoot(i.x,i.y,[c,c+PI2ToX(2)],[1],[8-.25*e]);if(1e3<=f&&f%12==0){var I=ranAngle(-40,40),w=ranAngle(-40,40),P=ranAngle(-PI2ToX(6),PI2ToX(6));for(let e=0;e<15;e++)enemyShoot(i.x+I,i.y+w,[h+P],[1],[7-.25*e])}}else if(116===i.type){if(f<=600&&f%10==0)for(let e=0;e<30;e++)enemyShoot(i.x,i.y,[e*PI2ToX(30)+f/400*PI2ToX(6)],[f<=150||300<=f&&f<=450?5:6],[6.5]);if(700==f||1400==f)for(let e=0;e<15;e++)enemyShoot(i.x,i.y,[h-Math.PI/3,h+Math.PI/3],[c,c+Math.PI/2,c+Math.PI,c+Math.PI/2*3],[1],[6-.25*e]);if(550<=f&&f<=950&&f%40==0)for(let e=0;e<16;e++){var M=i.x+45*Math.cos(e*Math.PI/8),E=i.y+45*Math.sin(e*Math.PI/8);enemyShoot(M,E,[getAngleTowardsPlayer(M,E)],[2],[8])}if(650<=f&&f<=1300&&f%50==0){var H=ranAngle(-PI2ToX(20),PI2ToX(20));for(let e=0;e<10;e++){var A=h+PI2ToX(10)*e+H;for(let e=0;e<24;e++)enemyShoot(i.x+40*Math.cos(e*Math.PI/12),i.y+40*Math.sin(e*Math.PI/12),[A],[6],[5])}}if(900<=f&&f<=1350&&f%50==0)for(let e=0;e<8;e++)enemyShoot(i.x,i.y,[h+e*PI2ToX(8)],[7],[4.5]);if(950<=f&&f<=1450&&f%70==0)for(let e=0;e<15;e++)enemyShoot(i.x,i.y,[c,c+Math.PI/2,c+Math.PI,c+Math.PI/2*3],[1],[5-.25*e]);1400<=f&&f%50<25&&enemyShoot(i.x,i.y,[h+currFrame%50*PI2ToX(48),h-currFrame%50*PI2ToX(48)],[2],[2.5])}}else{l=20===i.type?[h-PI2ToX(12),h+PI2ToX(12)]:[h,h-PI2ToX(24),h+PI2ToX(24)];enemyShoot(i.x,i.y,l,[7],[4])}}enemies=enemies.filter(e=>0<e.hp);for(var X of bullets){if(X.converted&&enemies.length){let e=1e9,t=null;for(var Y of enemies){var L=Math.hypot(X.x-Y.x,X.y-Y.y),b=Math.floor(Y.x/TILE_WIDTH/BLOCK_SIZE),G=Math.floor(Y.y/TILE_HEIGHT/BLOCK_SIZE);L<e&&playerBlockX===b&&playerBlockY===G&&(e=L,t=Y),L<=HIT_RADIUS&&(X.lifeTime=0,Y.hp=(Y.hp||1)-1,score+=25,particles.push({type:1,x:X.x,y:X.y,velX:4*(Math.random()-.5),velY:4*(Math.random()-.5),lifeTime:.5}),playSound("hit"))}var C;t&&(D=t.x-X.x,R=t.y-X.y,B=D/(D=Math.hypot(D,R)||1)*(k=Math.hypot(X.velX,X.velY)),R=R/D*k,X.velX*B+X.velY*R<-.99*k*k?(D=[-X.velY,X.velX],C=Math.hypot(D[0],D[1])||1,X.velX=.98*X.velX+D[0]/C*k*.02,X.velY=.98*X.velY+D[1]/C*k*.02):(X.velX=.82*X.velX+.18*B,X.velY=.82*X.velY+.18*R),D=Math.hypot(X.velX,X.velY)||1,C=Math.min(k+.08,10),X.velX=X.velX/D*C,X.velY=X.velY/D*C)}if(!X.converted){var B=X.x-playerX,R=X.y-playerY;if(Math.hypot(B,R)<=HIT_RADIUS&&invTime<=0&&0<hitPoints){X.lifeTime=0,playSound("alarm");for(let e=0;e<6;e++)particles.push({type:3,x:X.x,y:X.y,velX:4*(Math.random()-.5),velY:4*(Math.random()-.5),lifeTime:.5});invTime=.65,1<=shieldPoints?(shieldPoints--,texts.push({text:"Shield Blocked ("+Math.round(shieldPoints,1)+" Left)",x:X.x,y:X.y-20,color:"rgba(209, 106, 106, 1)",lifeTime:1})):(1<--hitPoints?texts.push({text:hitPoints+" Lifes Remaining",x:X.x,y:X.y-20,color:"rgba(255, 92, 92, 1)",lifeTime:1}):texts.push({text:"Caution: Last Life!",x:X.x,y:X.y-20,color:"rgba(255, 92, 92, 1)",lifeTime:1}),hitPoints<=0&&(stage=-Math.abs(stage)),shieldPoints=maxShieldPoints)}var _,k=Math.hypot(X.velX,X.velY)||1;if(2===X.type)X.velX=X.velX/k*Math.min(k+.06,5.8),X.velY=X.velY/k*Math.min(k+.06,5.8);else if(3===X.type)X.velX=X.velX/k*Math.max(k-.06,2),X.velY=X.velY/k*Math.max(k-.06,2);else if(4===X.type)X.velBX&&X.velBY||(X.velBX=-X.velX,X.velBY=-X.velY),X.velX=.992*X.velX+.008*X.velBX,X.velY=.992*X.velY+.008*X.velBY;else if(5===X.type||6===X.type)X._angle=X._angle??Math.atan2(X.velY,X.velX),X._angle+=5===X.type?.012:-.012,X.velX=Math.cos(X._angle)*k,X.velY=Math.sin(X._angle)*k;else if(7===X.type){if(!X._spawned&&2<k){var D=Math.max(k-.06,2);if(X.velX=X.velX/k*D,X.velY=X.velY/k*D,D<=2){X._spawned=!0;for(let e=0;e<12;e++)enemyShoot(X.x,X.y,[e*PI2ToX(12)],[1],[4.5]);X.lifeTime=0}}}else 8===X.type&&(_=getAngleTowardsPlayer(X.x,X.y),X.velX+=.12*Math.cos(_),X.velY+=.12*Math.sin(_),_=Math.hypot(X.velX,X.velY)||1,X.velX=X.velX/_*Math.min(_+.1,5.8),X.velY=X.velY/_*Math.min(_+.1,5.8))}X.x+=X.velX,X.y+=X.velY,getCollision(X.x,X.y)&&(X.lifeTime=0,particles.push({type:1,x:X.x,y:X.y,velX:4*(Math.random()-.5),velY:4*(Math.random()-.5),lifeTime:.5})),X.lifeTime-=1/60}if(bullets=bullets.filter(e=>0<e.lifeTime),texts=texts.filter(e=>0<e.lifeTime),particles=particles.filter(e=>0<e.lifeTime),keyState.enter&&stage%2==0&&stage<6&&!practicing&&(stage++,playSound("tip"),restartMap(),shieldPoints=3,1===stage?(hitPoints=3,score=0):3===stage?hitPoints+=1:5===stage&&(hitPoints+=2),titleShowTime=titleShowTimeMax,saveData()),keyState.r&&100===stage&&(practicing=!1,continued=!1,stage=0,restartMap()),(keyState[1]||keyState[2]||keyState[3])&&0===stage&&!practicing){if(keyState[3]&&unlockProgress<3||keyState[1]&&unlockProgress<1||keyState[2]&&unlockProgress<2)return;practicing=!0,playSound("tip"),stage=keyState[1]?1:keyState[2]?3:5,restartMap(),hitPoints=3,shieldPoints=3,enemies=[enemies[enemies.length-1]],playerX=enemies[0].x-448,playerY=enemies[0].y-448}0<stage&&0===enemies.length&&stage%2==1&&(practicing?stage=100:(stage++,playSound("tip"),bullets=[],saveData())),stage<-1e-9&&keyState.r&&(saveData(),stage=0,playSound("tip"),restartMap(),continued=!1,practicing=!1,score=0),stage<-1e-9&&keyState.enter&&(saveData(),stage=Math.abs(stage),playSound("tip"),continued=!0,hitPoints=3,shieldPoints=3,invTime=1,catPower=catPowerMax,score=Math.floor(.5*score)),practicing||(highScore=Math.max(highScore,score),unlockProgress=Math.max(unlockProgress,Math.floor(stage/2)))}function getAngleTowardsPlayer(e,t){e=playerX-e,t=playerY-t;return Math.atan2(t,e)}function getCollision(e,t){playerBlockX=Math.floor(playerX/TILE_WIDTH/BLOCK_SIZE),playerBlockY=Math.floor(playerY/TILE_HEIGHT/BLOCK_SIZE);e=Math.floor(e/TILE_WIDTH),t=Math.floor(t/TILE_HEIGHT);return map[t]&&"brick1"===map[t][e]||playerBlockX+playerBlockY>currLevel}function enemyShoot(t,a,o=[0],r=[1],s=[6],i=[10]){for(let e=0;e<o.length;e++){var l=o[e],n=r[e%r.length],h=s[e%s.length],c=i[e%i.length],n={type:n,x:t,y:a,velX:Math.cos(l)*h,velY:Math.sin(l)*h,lifeTime:c||10};bullets.push(n)}}function doCatDash(e,t){var a;0===e&&0===t||(dashTime=dashTimeMax,a=Math.hypot(e,t)||1,dashX=e/a*dashSpeed,dashY=t/a*dashSpeed,catPower-=dashPowerCost,texts.push({text:"Meow!",x:playerX,y:playerY,lifeTime:1,color:BRIGHT_BLUE}),invTime=0)}function getRadius(){return convertRadius+Math.floor(score/upgradeScore)*upgradeRadius}function draw(){resizeCanvas(),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#000",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.imageSmoothingEnabled=!1,ctx.textAlign="center";for(let t=0;t<MAP_SIZE;t++)for(let e=0;e<MAP_SIZE;e++){var a,o,r=map[t][e];imgDict[r]&&(a=e*TILE_WIDTH-offsetX,o=t*TILE_HEIGHT-offsetY,ctx.drawImage(imgDict[r],a,o,TILE_WIDTH,TILE_HEIGHT))}var t,e,s,i,l,n,h=playerX-canvas.width/2,c=playerY-canvas.height/2;if(offsetX=lerp(offsetX,h,.1),offsetY=lerp(offsetY,c,.1),0<hitPoints){ctx.save(),ctx.fillStyle=BRIGHT_BLUE,ctx.globalAlpha=.18,ctx.beginPath(),ctx.arc(playerX-offsetX,playerY-offsetY,getRadius(),0,2*Math.PI),playerCatStatus||0<invTime?ctx.fill():(ctx.strokeStyle=BRIGHT_BLUE,ctx.lineWidth=2,ctx.stroke()),ctx.restore();for(let e=1;e<=hitPoints;e++)ctx.drawImage(imgDict.life,canvas.width/2-20-32*e,canvas.height-45,24,24);for(let e=1;e<=maxShieldPoints;e++)e<=Math.floor(shieldPoints)?ctx.drawImage(imgDict.shield,canvas.width/2+20+32*e,canvas.height-45,24,24):e-1<shieldPoints&&shieldPoints<e&&0<(t=shieldPoints-Math.floor(shieldPoints))&&ctx.drawImage(imgDict.shield,0,0,8*t,8,canvas.width/2+20+32*e,canvas.height-45,24*t,24);ctx.save();var f=playerX-offsetX-33,y=playerY-offsetY+15;ctx.shadowColor=BRIGHT_BLUE,ctx.strokeStyle=BRIGHT_BLUE,ctx.fillStyle=BLUE,ctx.shadowBlur=32,ctx.fillRect(f,y,66*Math.min(catPower,catPowerMax)/catPowerMax,7),ctx.lineWidth=1.5;for(let e=1;e<=2;e++){var d=f+66*e/3;ctx.beginPath(),ctx.moveTo(d,y-5),ctx.lineTo(d,7+y+5),ctx.stroke()}ctx.restore();var h=playerCatStatus?CAT_WIDTH:PLAYER_WIDTH,c=playerCatStatus?CAT_HEIGHT:PLAYER_HEIGHT,x=playerX-h/2-offsetX;let e=playerY-c-offsetY;playerCatStatus&&(e-=20*Math.sin(Math.PI*(dashTimeMax-dashTime)/dashTimeMax));var m=mouseDownX+offsetX<playerX;ctx.save(),ctx.shadowColor=BRIGHT_BLUE,ctx.shadowBlur=64,m?(ctx.translate(x+h/2,0),ctx.scale(-1,1),ctx.drawImage(imgDict[playerCatStatus?"cat":"player"],-h/2,e,h,c)):ctx.drawImage(imgDict[playerCatStatus?"cat":"player"],x,e,h,c),ctx.restore(),mouseLeftDown&&!playerCatStatus&&(ctx.save(),ctx.fillStyle=RED,ctx.shadowColor=RED,ctx.shadowBlur=32,ctx.beginPath(),ctx.arc(playerX-offsetX,playerY+BULLET_OFFSET_Y-offsetY,4,0,2*Math.PI),ctx.fill(),ctx.restore())}for(e of enemies){var p=e.x>=playerX,v=e.x-PLAYER_WIDTH/2-offsetX,g=e.y-PLAYER_HEIGHT-offsetY;ctx.save(),ctx.shadowColor=RED,ctx.shadowBlur=64,p?(ctx.translate(v+PLAYER_WIDTH/2,0),ctx.scale(-1,1),ctx.drawImage(imgDict.enemy,-PLAYER_WIDTH/2,g,PLAYER_WIDTH,PLAYER_HEIGHT)):ctx.drawImage(imgDict.enemy,v,g,PLAYER_WIDTH,PLAYER_HEIGHT),ctx.restore()}for(s of bullets){var u=s.x-offsetX,T=s.y-offsetY+BULLET_OFFSET_Y,S=Math.atan2(s.velY,s.velX);ctx.save(),ctx.translate(u,T),ctx.rotate(S),ctx.drawImage(s.converted?imgDict.bulletc:5<=s.type?imgDict.bullet1:imgDict.bullet2,-BULLET_SIZE/2,-BULLET_SIZE/2,BULLET_SIZE,BULLET_SIZE),ctx.restore()}ctx.font="16px "+FONTS;for(i of texts)i.lifeTime-=1/60,ctx.fillStyle=i.color||GREY,ctx.fillText(i.text,i.x-offsetX,i.y-offsetY-12*Math.sin((1-i.lifeTime)*Math.PI/2));for(l of particles)l.x+=l.velX,l.y+=l.velY,l.lifeTime-=1/60,1===l.type?(ctx.save(),ctx.fillStyle=GREY,ctx.beginPath(),ctx.arc(l.x-offsetX,l.y-offsetY,3,0,2*Math.PI),ctx.fill(),ctx.restore()):2!==l.type&&3!==l.type&&4!==l.type||(ctx.save(),ctx.translate(l.x-offsetX,l.y-offsetY),n=4*(l.lifeTime||0)*Math.PI,ctx.rotate(n),ctx.strokeStyle=2===l.type?BRIGHT_BLUE:3===l.type?RED:GREY,ctx.lineWidth=2,ctx.strokeRect(-11,-11,22,22),ctx.restore());if(1===stage&&(drawText("Use [W][A][S][D] to Move",512-offsetX,392-offsetY),drawText("[Mouse Right Click] Or [Space] to turn into a Black Cat and dash",512-offsetX,422-offsetY),m=512+(moveFlags[0]?1024:0),x=512+(moveFlags[0]?0:1024),drawText("When transformed into a cat, a field of doom forms around you",m-offsetX,x-120-offsetY),drawText("Enemy bullets affected by doom will turn to attack themselves",m-offsetX,x-90-offsetY),drawText("Try defeat the guard here",m-offsetX,x-60-offsetY),m+=moveFlags[1]?1024:0,x+=moveFlags[1]?0:1024,drawText("Be careful! You will lose shield/hit-points when being hit.",m-offsetX,x-30-offsetY),drawText("When hit-points drop to 0, Rin will fail to escape.",m-offsetX,x-offsetY),m+=moveFlags[2]?1024:0,x+=moveFlags[2]?0:1024,drawText("Lost shield points can be recovered by converting bullets.",m-offsetX,x-30-offsetY),drawText("If your shield is insufficient to block a bullet, you will lose life.",m-offsetX,x-offsetY)),3===stage&&(drawText("Each 100000 points will make convert range larger.",512-offsetX,392-offsetY),drawText("When you die and choose to continue, you will score.",512-offsetX,422-offsetY)),1===enemies.length&&114<=enemies[0].type){h=enemies.length?enemies[0].hp/(enemies[0].maxHp||1):0;lastRatio=lerp(lastRatio,h,.05),drawText(["Cauchy's Clone v.1.17","Cauchy's Clone v2.0","Cauchy The Cat Witch"][enemies[0].type-114],canvas.width/4-100,25,RED,"18px"),ctx.save(),ctx.globalAlpha=.24,ctx.fillStyle=RED,ctx.fillRect(canvas.width/4,15,canvas.width/2*lastRatio,10),ctx.restore(),drawText(Math.round(100*lastRatio,1)+"%",canvas.width/4+lastRatio*canvas.width/2+25,25,RED,"18px")}else{ctx.save(),ctx.fillStyle=BLUE,ctx.strokeStyle=BRIGHT_BLUE,ctx.shadowColor=BRIGHT_BLUE,ctx.shadowBlur=16,lastProgressDraw=lerp(lastProgressDraw,(playerBlockX+playerBlockY)/(2*BLOCKS-2),.02),ctx.fillRect(canvas.width/4,15,canvas.width/2*lastProgressDraw,10);var I=canvas.width/(4*BLOCKS-4);for(let e=0;e<BLOCKS-1;e++)ctx.beginPath(),ctx.moveTo(canvas.width/2+e*I,10),ctx.lineTo(canvas.width/2+e*I,30),ctx.stroke(),ctx.beginPath(),ctx.moveTo(canvas.width/2-e*I,10),ctx.lineTo(canvas.width/2-e*I,30),ctx.stroke();drawText(Math.round(100*lastProgressDraw,1)+"%",canvas.width/4+lastProgressDraw*canvas.width/2+25,25,BLUE,"18px"),ctx.restore()}if(practicing?drawText("Practice Mode",canvas.width/2,canvas.height-60,BLUE):playerBlockX+playerBlockY===currLevel?drawText("Eliminate Enemies in this room",canvas.width/2,canvas.height-60,BLUE):drawText("Reach the next room to escape",canvas.width/2,canvas.height-60,BLUE),drawText("Score: "+String(score).padStart(6,"0"),canvas.width/2,45,BLUE),0<titleShowTime&&(ctx.globalAlpha=Math.sin(titleShowTime/titleShowTimeMax*Math.PI),drawText("Cauchy's Basement",canvas.width/2,canvas.height/2-40,BRIGHT_BLUE,"62px"),drawText("Floor "+(Math.floor(stage/2)+1)+"/3",canvas.width/2+60,canvas.height/2,BRIGHT_BLUE,"42px"),titleShowTime-=1/60,ctx.globalAlpha=1),ctx.save(),ctx.globalAlpha=1,ctx.filter=`blur(${12*Math.abs(maskAlpha)}px)`,ctx.drawImage(canvas,0,0),ctx.filter="none",ctx.restore(),maskAlpha=stage%2==1?lerp(maskAlpha,0,.1):lerp(maskAlpha,1,.1),0===stage){drawText("Rin the Cat Sorceresses",canvas.width/2,canvas.height/2,GREY,"62px"),drawText("Press [Enter] to Start",canvas.width/2,canvas.height/2+120,GREY,"24px");let t="Defeat Bosses (Accept Continuing) to Unlock Practice Mode";if(0<unlockProgress){t="Press ";for(let e=1;e<=Math.min(unlockProgress,3);e++)t+="["+e+"] ";t+=" to Practice Boss fights"}drawText(t,canvas.width/2,canvas.height/2+150,GREY,"24px"),drawText("High-Score: "+highScore,canvas.width/2,canvas.height-80,GREY,"24px"),2===clearStatus?drawText("True Ending Achieved!",canvas.width/2,canvas.height-50,BRIGHT_BLUE,"24px"):1===clearStatus&&drawText("Normal Ending Achieved!",canvas.width/2,canvas.height-50,GREY,"24px")}2<=stage&&stage<=4&&stage%2==0&&(bullets=[],drawText("Stage "+Math.floor(stage/2)+"/3 Clear",canvas.width/2,canvas.height/2-120,GREY,"42px"),drawText("Press [Enter] to Upstairs",canvas.width/2,canvas.height/2+120,GREY,"24px")),6===stage&&(bullets=[],drawText("Stage All Clear!",canvas.width/2,canvas.height/2-120,GREY,"42px"),drawText("The Cat Sorceresses Rin Finally Defeat the Evil Cat Witch and Escape!",canvas.width/2,canvas.height/2-80,GREY,"24px"),drawText("--- With her Black Cat Power",canvas.width/2+30,canvas.height/2-40,GREY,"24px"),continued?(drawText("However, Rin accidently let Cauchy escape",canvas.width/2,canvas.height/2+40,GREY,"24px"),drawText("Cauchy, the Evil Cat Witch, is still at large...",canvas.width/2,canvas.height/2+80,GREY,"24px"),drawText("[Try beat the game without continuing!]",canvas.width/2,canvas.height/2+120,GREY,"24px"),clearStatus<1&&(clearStatus=1,saveData())):(drawText("Congratulations!",canvas.width/2,canvas.height/2+40,GREY,"24px"),drawText("Thanks to your skill, Cauchy is sealed away for good.",canvas.width/2,canvas.height/2+120,GREY,"24px"),drawText("You Achieved the True Ending! Thanks for Playing!",canvas.width/2,canvas.height/2+160,BRIGHT_BLUE,"24px"),clearStatus<2&&(clearStatus=2,saveData())),drawText("Your Final Score: "+score,canvas.width/2,canvas.height-80,continued?GREY:BRIGHT_BLUE,"32px")),100===stage&&(bullets=[],drawText("Practice Mode Finished!",canvas.width/2,canvas.height/2,GREY,"62px"),drawText("Press [R] to Return to Menu",canvas.width/2,canvas.height/2+120,GREY,"24px")),stage<-1e-9&&(drawText("Game Over",canvas.width/2,canvas.height/2,GREY,"62px"),drawText("Press [Enter] to Continue",canvas.width/2,canvas.height/2+120,GREY,"24px"),drawText("Press [R] to Restart",canvas.width/2,canvas.height/2+150,GREY,"24px"),drawText("Continuing will affect the final ending",canvas.width/2,canvas.height/2+180,GREY,"18px"))}function resizeCanvas(){canvas.width=window.innerWidth,canvas.height=window.innerHeight}function drawText(e,t,a,o=GREY,r="18px"){ctx.save(),ctx.font=r+" "+FONTS,ctx.fillStyle=o,ctx.fillText(e,t,a),ctx.restore()}document.addEventListener("keydown",e=>{keyState[e.key.toLowerCase()]=!0," "===e.key&&doCatDash(keyState.a?-1:0+keyState.d?1:0,keyState.w?-1:0+keyState.s?1:0)}),document.addEventListener("keyup",e=>{keyState[e.key.toLowerCase()]=!1}),canvas.addEventListener("contextmenu",e=>e.preventDefault()),canvas.addEventListener("mousemove",e=>{mouseDownX=e.offsetX,mouseDownY=e.offsetY}),canvas.addEventListener("mousedown",e=>{0===e.button&&(mouseLeftDown=!0),2===e.button&&dashTime<=0&&catPower>=dashPowerCost&&(mouseRightDown=!0,mouseDownX=e.offsetX,mouseDownY=e.offsetY,doCatDash(mouseDownX+offsetX-playerX,mouseDownY+offsetY-playerY))}),canvas.addEventListener("mouseup",e=>{0===e.button&&(mouseLeftDown=!1),2===e.button&&(mouseRightDown=!1)}),restartMap();let playColdDown=0,audioCtx=window.AudioContext?new window.AudioContext:window.webkitAudioContext?new window.webkitAudioContext:null;function playSound(t){if(audioCtx&&!(1e-9<playColdDown&&"alarm"!==t)){var a=audioCtx.currentTime;if("alarm"===t||"tip"===t||"hit"===t)for(let e=0;e<("alarm"===t?4:1);e++){var o=audioCtx.createOscillator(),r=audioCtx.createGain(),s=(o.type="sine",o.frequency.value="hit"===t?450:1200,new Float32Array([0,1,.4,.2,.1])),i=new Float32Array(s.length),s=audioCtx.createPeriodicWave(s,i),i=(o.setPeriodicWave(s),o.connect(r).connect(audioCtx.destination),r.gain.value=.18,a+.1*e);o.start(i),r.gain.setValueAtTime(.18,i),r.gain.linearRampToValueAtTime(0,i+.15),o.stop(i+.16)}else if("parry"===t){var e=audioCtx.createBuffer(1,2200,audioCtx.sampleRate),l=e.getChannelData(0);for(let e=0;e<l.length;e++)l[e]=(2*Math.random()-1)*Math.exp(-e/400);var n=audioCtx.createBufferSource(),h=audioCtx.createGain();n.buffer=e,n.connect(h).connect(audioCtx.destination),h.gain.value=.22,n.start(a),h.gain.setValueAtTime(.22,a),h.gain.linearRampToValueAtTime(0,a+.07),n.stop(a+.14)}playColdDown=.05}}function PI2ToX(e=1){return 2*Math.PI/e}function lerp(e,t,a){return e+(t-e)*a}function ranAngle(e,t){return Math.random()*(t-e)+e}function ranInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}function getData(){try{highScore=parseInt(localStorage.getItem("highScore"))||0,unlockProgress=parseInt(localStorage.getItem("unlockProgress"))||0,clearStatus=parseInt(localStorage.getItem("clearStatus"))||0}catch(e){}}function saveData(){practicing||(highScore=Math.max(highScore,score),unlockProgress=Math.max(unlockProgress,Math.floor(stage/2)));try{localStorage.setItem("highScore",highScore),localStorage.setItem("unlockProgress",unlockProgress),localStorage.setItem("clearStatus",clearStatus)}catch(e){}}function loop(){update(),draw()}getData(),setInterval(loop,1e3/60);