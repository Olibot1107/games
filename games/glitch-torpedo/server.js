function findOpponent(a){for(var b=0;b<users.length;b++)a!==users[b]&&null===users[b].opponent&&new Game(a,users[b]).start()}function removeUser(a){users.splice(users.indexOf(a),1)}function Game(a,b){a.role="sub",b.role="ship",this.user1=a,this.user2=b,this.lG=Math.floor(5*Math.random())+5,this.cnt=0}function generateGlitch(){for(var a=[],b=rand(30,60),c=0;b>c;c++){var d=[rand(0,256),rand(0,216)],e=[rand(10,30),rand(15,40)],f=[rand(0,255),rand(0,255),rand(0,255),.5*Math.random()+.5];a.push([d,e,f])}return a}function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a}function checkG(a){if(a.game.cnt++>a.game.lG){a.game.cnt=0,a.game.lG=Math.floor(5*Math.random())+5;for(var b=rand(2,7),c=[],d=0;b>d;d++){var e=generateGlitch(),f=rand(75,500);c.push([e,f])}if(a.socket.emit("glitch",c),a.opponent.socket.emit("glitch",c),rand(0,1)){var g=Math.PI,h=[];h[0]=rand(0,1)?g/2:rand(0,1)?-g/2:g,h[1]=rand(-25,25),h[2]=rand(-25,25);var f=rand(1500,3500);a.socket.emit("rot",h,f),a.opponent.socket.emit("rot",h,f)}}}function User(a){this.socket=a,this.game=null,this.opponent=null}var users=[];Game.prototype.start=function(){this.user1.start(this,this.user2),this.user2.start(this,this.user1)},User.prototype.start=function(a,b){this.game=a,this.opponent=b;var c={p1:this.name,p2:this.opponent.name,role:this.role};this.socket.emit("start",c)},User.prototype.end=function(){this.socket.emit("end"),this.game=null,this.opponent=null},module.exports=function(a){var b=new User(a);a.on("disconnect",function(){removeUser(b),b.opponent&&(b.opponent.end(),findOpponent(b.opponent))}),a.on("controls",function(a,c){b.opponent.socket.emit("controls",a,c)}),a.on("syncronizeSunk",function(a){b.opponent.socket.emit("syncronizeSunk",a)}),a.on("launchCharge",function(a){b.opponent.socket.emit("launchCharge",a),checkG(b)}),a.on("launchSub",function(a){b.opponent.socket.emit("launchSub",a)}),a.on("silent",function(){b.opponent.socket.emit("silent")}),a.on("launchTorpedo",function(a,c){b.opponent.socket.emit("launchTorpedo",a,c),checkG(b)}),a.on("name",function(a){b.name=a,users.push(b),findOpponent(b)}),b.socket.emit("welcome",users.length+1)};